<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>lang/minikanren/simple.scm</title>
</head>
<body>
<pre style="white-space: pre-wrap;">;; #lang racket

;;; This file was generated by writeminikanren.pl
;;; Generated at 2007-10-25 15:24:42

(define-syntax lambdag@
  (syntax-rules ()
    ((_ (p) e) (lambda (p) e))))

(define-syntax lambdaf@
  (syntax-rules ()
    ((_ () e) (lambda () e))))

(define-syntax run*
  (syntax-rules ()
    ((_ (x) g ...) (run #f (x) g ...))))

(define-syntax rhs
  (syntax-rules ()
    ((_ x) (cdr x))))

(define-syntax lhs
  (syntax-rules ()
    ((_ x) (car x))))

(define-syntax size-s
  (syntax-rules ()
    ((_ x) (length x))))

(define-syntax var
  (syntax-rules ()
    ((_ x) (vector x))))

(define-syntax var?
  (syntax-rules ()
    ((_ x) (vector? x))))

(define empty-s &apos;())

(define walk
  (lambda (u S)
    (cond
      ((and (var? u) (assq u S)) =&gt;
       (lambda (pr) (walk (rhs pr) S)))
      (else u))))

(define ext-s
  (lambda (x v s)
    (cons `(,x . ,v) s)))

(define unify
  (lambda (u v s)
    (let ((u (walk u s))
          (v (walk v s)))
      (cond
        ((eq? u v) s)
        ((var? u) (ext-s-check u v s))
        ((var? v) (ext-s-check v u s))
        ((and (pair? u) (pair? v))
         (let ((s (unify
                    (car u) (car v) s)))
           (and s (unify
                    (cdr u) (cdr v) s))))
        ((equal? u v) s)
        (else #f)))))

(define ext-s-check
  (lambda (x v s)
    (cond
      ((occurs-check x v s) #f)
      (else (ext-s x v s)))))

(define occurs-check
  (lambda (x v s)
    (let ((v (walk v s)))
      (cond
        ((var? v) (eq? v x))
        ((pair? v)
         (or
           (occurs-check x (car v) s)
           (occurs-check x (cdr v) s)))
        (else #f)))))

(define walk*
  (lambda (w s)
    (let ((v (walk w s)))
      (cond
        ((var? v) v)
        ((pair? v)
         (cons
           (walk* (car v) s)
           (walk* (cdr v) s)))
        (else v)))))

(define reify-s
  (lambda (v s)
    (let ((v (walk v s)))
      (cond
        ((var? v)
         (ext-s v (reify-name (size-s s)) s))
        ((pair? v) (reify-s (cdr v)
                     (reify-s (car v) s)))
        (else s)))))

(define reify-name
  (lambda (n)
    (string-&gt;symbol
      (string-append &quot;_&quot; &quot;.&quot; (number-&gt;string n)))))

(define reify
  (lambda (v s)
    (let ((v (walk* v s)))
      (walk* v (reify-s v empty-s)))))

(define-syntax mzero
  (syntax-rules () ((_) #f)))

(define-syntax inc
  (syntax-rules () ((_ e) (lambdaf@ () e))))

(define-syntax unit
  (syntax-rules () ((_ a) a)))

(define-syntax choice
  (syntax-rules () ((_ a f) (cons a f))))

(define-syntax case-inf
  (syntax-rules ()
    ((_ e (() e0) ((f^) e1) ((a^) e2) ((a f) e3))
     (let ((a-inf e))
       (cond
         ((not a-inf) e0)
         ((procedure? a-inf)  (let ((f^ a-inf)) e1))
         ((not (and (pair? a-inf)
                    (procedure? (cdr a-inf))))
          (let ((a^ a-inf)) e2))
         (else (let ((a (car a-inf)) (f (cdr a-inf)))
                 e3)))))))

(define-syntax run
  (syntax-rules ()
    ((_ n (x) g0 g ...)
     (take n
       (lambdaf@ ()
         ((fresh (x) g0 g ...
            (lambdag@ (s)
              (cons (reify x s) &apos;())))
          empty-s))))))

(define take
  (lambda (n f)
    (if (and n (zero? n))
      &apos;()
      (case-inf (f)
        (() &apos;())
        ((f) (take n f))
        ((a) a)
        ((a f)
         (cons (car a)
           (take (and n (- n 1)) f)))))))

(define ==
  (lambda (u v)
    (lambdag@ (s)
      (unify u v s))))

(define-syntax fresh
  (syntax-rules ()
    ((_ (x ...) g0 g ...)
     (lambdag@ (s)
       (inc
         (let ((x (var &apos;x)) ...)
           (bind* (g0 s) g ...)))))))

(define-syntax bind*
  (syntax-rules ()
    ((_ e) e)
    ((_ e g0 g ...) (bind* (bind e g0) g ...))))

(define bind
  (lambda (a-inf g)
    (case-inf a-inf
      (() (mzero))
      ((f) (inc (bind (f) g)))
      ((a) (g a))
      ((a f) (mplus (g a) (lambdaf@ () (bind (f) g)))))))

(define-syntax conde
  (syntax-rules ()
    ((_ (g0 g ...) (g1 g^ ...) ...)
     (lambdag@ (s)
       (inc
         (mplus*
           (bind* (g0 s) g ...)
           (bind* (g1 s) g^ ...) ...))))))

(define-syntax mplus*
  (syntax-rules ()
    ((_ e) e)
    ((_ e0 e ...) (mplus e0
                    (lambdaf@ () (mplus* e ...))))))

(define mplus
  (lambda (a-inf f)
    (case-inf a-inf
      (() (f))
      ((f^) (inc (mplus (f) f^)))
      ((a) (choice a f))
      ((a f^) (choice a (lambdaf@ () (mplus (f) f^)))))))

(define-syntax conda
  (syntax-rules ()
    ((_ (g0 g ...) (g1 g^ ...) ...)
     (lambdag@ (s)
       (inc
         (ifa ((g0 s) g ...)
              ((g1 s) g^ ...) ...))))))

(define-syntax ifa
  (syntax-rules ()
    ((_) (mzero))
    ((_ (e g ...) b ...)
     (let loop ((a-inf e))
       (case-inf a-inf
         (() (ifa b ...))
         ((f) (inc (loop (f))))
         ((a) (bind* a-inf g ...))
         ((a f) (bind* a-inf g ...)))))))

(define-syntax condu
  (syntax-rules ()
    ((_ (g0 g ...) (g1 g^ ...) ...)
     (lambdag@ (s)
       (inc
         (ifu ((g0 s) g ...)
              ((g1 s) g^ ...) ...))))))

(define-syntax ifu
  (syntax-rules ()
    ((_) (mzero))
    ((_ (e g ...) b ...)
     (let loop ((a-inf e))
       (case-inf a-inf
         (() (ifu b ...))
         ((f) (inc (loop (f))))
         ((a) (bind* a-inf g ...))
         ((a f) (bind* (unit a) g ...)))))))

(define-syntax project
  (syntax-rules ()
    ((_ (x ...) g g* ...)
     (lambdag@ (s)
       (let ((x (walk* x s)) ...)
         ((fresh () g g* ...) s))))))

(define succeed (== #f #f))

(define fail (== #f #t))

(define onceo
  (lambda (g)
    (condu
      (g succeed)
      ((== #f #f) fail))))

(define-syntax run1 (syntax-rules () ((_ (x) g0 g ...) (run 1 (x) g0 g ...))))
(define-syntax run2 (syntax-rules () ((_ (x) g0 g ...) (run 2 (x) g0 g ...))))
(define-syntax run3 (syntax-rules () ((_ (x) g0 g ...) (run 3 (x) g0 g ...))))
(define-syntax run4 (syntax-rules () ((_ (x) g0 g ...) (run 4 (x) g0 g ...))))
(define-syntax run5 (syntax-rules () ((_ (x) g0 g ...) (run 5 (x) g0 g ...))))
(define-syntax run6 (syntax-rules () ((_ (x) g0 g ...) (run 6 (x) g0 g ...))))
(define-syntax run7 (syntax-rules () ((_ (x) g0 g ...) (run 7 (x) g0 g ...))))
(define-syntax run8 (syntax-rules () ((_ (x) g0 g ...) (run 8 (x) g0 g ...))))
(define-syntax run9 (syntax-rules () ((_ (x) g0 g ...) (run 9 (x) g0 g ...))))
(define-syntax run10 (syntax-rules () ((_ (x) g0 g ...) (run 10 (x) g0 g ...))))

(define-syntax run11 (syntax-rules () ((_ (x) g0 g ...) (run 11 (x) g0 g ...))))
(define-syntax run12 (syntax-rules () ((_ (x) g0 g ...) (run 12 (x) g0 g ...))))
(define-syntax run13 (syntax-rules () ((_ (x) g0 g ...) (run 13 (x) g0 g ...))))
(define-syntax run14 (syntax-rules () ((_ (x) g0 g ...) (run 14 (x) g0 g ...))))
(define-syntax run15 (syntax-rules () ((_ (x) g0 g ...) (run 15 (x) g0 g ...))))
(define-syntax run16 (syntax-rules () ((_ (x) g0 g ...) (run 16 (x) g0 g ...))))
(define-syntax run17 (syntax-rules () ((_ (x) g0 g ...) (run 17 (x) g0 g ...))))
(define-syntax run18 (syntax-rules () ((_ (x) g0 g ...) (run 18 (x) g0 g ...))))
(define-syntax run19 (syntax-rules () ((_ (x) g0 g ...) (run 19 (x) g0 g ...))))
(define-syntax run20 (syntax-rules () ((_ (x) g0 g ...) (run 20 (x) g0 g ...))))

(define-syntax run21 (syntax-rules () ((_ (x) g0 g ...) (run 21 (x) g0 g ...))))
(define-syntax run22 (syntax-rules () ((_ (x) g0 g ...) (run 22 (x) g0 g ...))))
(define-syntax run23 (syntax-rules () ((_ (x) g0 g ...) (run 23 (x) g0 g ...))))
(define-syntax run24 (syntax-rules () ((_ (x) g0 g ...) (run 24 (x) g0 g ...))))
(define-syntax run25 (syntax-rules () ((_ (x) g0 g ...) (run 25 (x) g0 g ...))))
(define-syntax run26 (syntax-rules () ((_ (x) g0 g ...) (run 26 (x) g0 g ...))))
(define-syntax run27 (syntax-rules () ((_ (x) g0 g ...) (run 27 (x) g0 g ...))))
(define-syntax run28 (syntax-rules () ((_ (x) g0 g ...) (run 28 (x) g0 g ...))))
(define-syntax run29 (syntax-rules () ((_ (x) g0 g ...) (run 29 (x) g0 g ...))))
(define-syntax run30 (syntax-rules () ((_ (x) g0 g ...) (run 30 (x) g0 g ...))))

(define-syntax run31 (syntax-rules () ((_ (x) g0 g ...) (run 31 (x) g0 g ...))))
(define-syntax run32 (syntax-rules () ((_ (x) g0 g ...) (run 32 (x) g0 g ...))))
(define-syntax run33 (syntax-rules () ((_ (x) g0 g ...) (run 33 (x) g0 g ...))))
(define-syntax run34 (syntax-rules () ((_ (x) g0 g ...) (run 34 (x) g0 g ...))))
(define-syntax run35 (syntax-rules () ((_ (x) g0 g ...) (run 35 (x) g0 g ...))))
(define-syntax run36 (syntax-rules () ((_ (x) g0 g ...) (run 36 (x) g0 g ...))))
(define-syntax run37 (syntax-rules () ((_ (x) g0 g ...) (run 37 (x) g0 g ...))))
(define-syntax run38 (syntax-rules () ((_ (x) g0 g ...) (run 38 (x) g0 g ...))))
(define-syntax run39 (syntax-rules () ((_ (x) g0 g ...) (run 39 (x) g0 g ...))))
(define-syntax run40 (syntax-rules () ((_ (x) g0 g ...) (run 40 (x) g0 g ...))))

(define caro
  (lambda (p a)
    (fresh (d)
      (== (cons a d) p))))

(define cdro
  (lambda (p d)
    (fresh (a)
      (== (cons a d) p))))

(define conso
  (lambda (a d p)
    (== (cons a d) p)))

(define nullo
  (lambda (x)
    (== &apos;() x)))

(define eqo
  (lambda (x y)
    (== x y)))

(define pairo
  (lambda (p)
    (fresh (a d)
      (conso a d p))))

(define membero
  (lambda (x l)
    (conde
      ((fresh (a)
         (caro l a)
         (== a x)))
      ((fresh (d)
         (cdro l d)
         (membero x d))))))

(define rembero
  (lambda (x l out)
    (conde
      ((nullo l) (== &apos;() out))
      ((caro l x) (cdro l out))
      ((fresh (a d res)
         (conso a d l)
         (rembero x d res)
         (conso a res out))))))

(define appendo
  (lambda (l s out)
    (conde
      ((nullo l) (== s out))
      ((fresh (a d res)
         (conso a d l)
         (conso a res out)
         (appendo d s res))))))

(define flatteno
  (lambda (s out)
    (conde
      ((nullo s) (== &apos;() out))
      ((pairo s)
       (fresh (a d res-a res-d)
         (conso a d s)
         (flatteno a res-a)
         (flatteno d res-d)
         (appendo res-a res-d out)))
      ((conso s &apos;() out)))))

(define anyo
  (lambda (g)
    (conde
      (g)
      ((anyo g)))))

(define nevero (anyo fail))
(define alwayso (anyo succeed))



(define build-num
  (lambda (n)
    (cond
      ((odd? n)
       (cons 1
         (build-num (quotient (- n 1) 2))))
      ((and (not (zero? n)) (even? n))
       (cons 0
         (build-num (quotient n 2))))
      ((zero? n) &apos;()))))

(define poso
  (lambda (n)
    (fresh (a d)
      (== `(,a . ,d) n))))

(define &gt;1o
  (lambda (n)
    (fresh (a ad dd)
      (== `(,a ,ad . ,dd) n))))

(define full-addero
  (lambda (b x y r c)
    (conde
      ((== 0 b) (== 0 x) (== 0 y) (== 0 r) (== 0 c))
      ((== 1 b) (== 0 x) (== 0 y) (== 1 r) (== 0 c))
      ((== 0 b) (== 1 x) (== 0 y) (== 1 r) (== 0 c))
      ((== 1 b) (== 1 x) (== 0 y) (== 0 r) (== 1 c))
      ((== 0 b) (== 0 x) (== 1 y) (== 1 r) (== 0 c))
      ((== 1 b) (== 0 x) (== 1 y) (== 0 r) (== 1 c))
      ((== 0 b) (== 1 x) (== 1 y) (== 0 r) (== 1 c))
      ((== 1 b) (== 1 x) (== 1 y) (== 1 r) (== 1 c)))))

(define addero
  (lambda (d n m r)
    (conde
      ((== 0 d) (== &apos;() m) (== n r))
      ((== 0 d) (== &apos;() n) (== m r)
       (poso m))
      ((== 1 d) (== &apos;() m)
       (addero 0 n &apos;(1) r))
      ((== 1 d) (== &apos;() n) (poso m)
       (addero 0 &apos;(1) m r))
      ((== &apos;(1) n) (== &apos;(1) m)
       (fresh (a c)
         (== `(,a ,c) r)
         (full-addero d 1 1 a c)))
      ((== &apos;(1) n) (gen-addero d n m r))
      ((== &apos;(1) m) (&gt;1o n) (&gt;1o r)
       (addero d &apos;(1) n r))
      ((&gt;1o n) (gen-addero d n m r)))))

(define gen-addero
  (lambda (d n m r)
    (fresh (a b c e x y z)
      (== `(,a . ,x) n)
      (== `(,b . ,y) m) (poso y)
      (== `(,c . ,z) r) (poso z)
      (full-addero d a b c e)
      (addero e x y z))))

(define pluso
  (lambda (n m k)
    (addero 0 n m k)))

(define minuso
  (lambda (n m k)
    (pluso m k n)))

(define *o
  (lambda (n m p)
    (conde
      ((== &apos;() n) (== &apos;() p))
      ((poso n) (== &apos;() m) (== &apos;() p))
      ((== &apos;(1) n) (poso m) (== m p))
      ((&gt;1o n) (== &apos;(1) m) (== n p))
      ((fresh (x z)
         (== `(0 . ,x) n) (poso x)
         (== `(0 . ,z) p) (poso z)
         (&gt;1o m)
         (*o x m z)))
      ((fresh (x y)
         (== `(1 . ,x) n) (poso x)
         (== `(0 . ,y) m) (poso y)
         (*o m n p)))
      ((fresh (x y)
         (== `(1 . ,x) n) (poso x)
         (== `(1 . ,y) m) (poso y)
         (odd-*o x n m p))))))

(define odd-*o
  (lambda (x n m p)
    (fresh (q)
      (bound-*o q p n m)
      (*o x m q)
      (pluso `(0 . ,q) m p))))

(define bound-*o
  (lambda (q p n m)
    (conde
      ((nullo q) (pairo p))
      ((fresh (x y z)
         (cdro q x)
         (cdro p y)
         (conde
           ((nullo n)
            (cdro m z)
            (bound-*o x y z &apos;()))
           ((cdro n z)
            (bound-*o x y z m))))))))

(define =lo
  (lambda (n m)
    (conde
      ((== &apos;() n) (== &apos;() m))
      ((== &apos;(1) n) (== &apos;(1) m))
      ((fresh (a x b y)
         (== `(,a . ,x) n) (poso x)
         (== `(,b . ,y) m) (poso y)
         (=lo x y))))))

(define &lt;lo
  (lambda (n m)
    (conde
      ((== &apos;() n) (poso m))
      ((== &apos;(1) n) (&gt;1o m))
      ((fresh (a x b y)
         (== `(,a . ,x) n) (poso x)
         (== `(,b . ,y) m) (poso y)
         (&lt;lo x y))))))

(define &lt;=lo
  (lambda (n m)
    (conde
      ((=lo n m))
      ((&lt;lo n m)))))

(define &lt;o
  (lambda (n m)
    (conde
      ((&lt;lo n m))
      ((=lo n m)
       (fresh (x)
         (poso x)
         (pluso n x m))))))

(define &lt;=o
  (lambda (n m)
    (conde
      ((== n m))
      ((&lt;o n m)))))

(define /o
  (lambda (n m q r)
    (conde
      ((== r n) (== &apos;() q) (&lt;o n m))
      ((== &apos;(1) q) (=lo n m) (pluso r m n)
       (&lt;o r m))
      ((&lt;lo m n)
       (&lt;o r m)
       (poso q)
       (fresh (nh nl qh ql qlm qlmr rr rh)
         (splito n r nl nh)
         (splito q r ql qh)
         (conde
           ((== &apos;() nh)
            (== &apos;() qh)
            (minuso nl r qlm)
            (*o ql m qlm))
           ((poso nh)
            (*o ql m qlm)
            (pluso qlm r qlmr)
            (minuso qlmr nl rr)
            (splito rr r &apos;() rh)
            (/o nh m qh rh))))))))

(define splito
  (lambda (n r l h)
    (conde
      ((== &apos;() n) (== &apos;() h) (== &apos;() l))
      ((fresh (b n^)
         (== `(0 ,b . ,n^) n)
         (== &apos;() r)
         (== `(,b . ,n^) h)
         (== &apos;() l)))
      ((fresh (n^)
         (==  `(1 . ,n^) n)
         (== &apos;() r)
         (== n^ h)
         (== &apos;(1) l)))
      ((fresh (b n^ a r^)
         (== `(0 ,b . ,n^) n)
         (== `(,a . ,r^) r)
         (== &apos;() l)
         (splito `(,b . ,n^) r^ &apos;() h)))
      ((fresh (n^ a r^)
         (== `(1 . ,n^) n)
         (== `(,a . ,r^) r)
         (== &apos;(1) l)
         (splito n^ r^ &apos;() h)))
      ((fresh (b n^ a r^ l^)
         (== `(,b . ,n^) n)
         (== `(,a . ,r^) r)
         (== `(,b . ,l^) l)
         (poso l^)
         (splito n^ r^ l^ h))))))

(define logo
 (lambda (n b q r)
   (conde
     ((== &apos;(1) n) (poso b) (== &apos;() q) (== &apos;() r))
     ((== &apos;() q) (&lt;o n b) (pluso r &apos;(1) n))
     ((== &apos;(1) q) (&gt;1o b) (=lo n b) (pluso r b n))
     ((== &apos;(1) b) (poso q) (pluso r &apos;(1) n))
     ((== &apos;() b) (poso q) (== r n))
     ((== &apos;(0 1) b)
      (fresh (a ad dd)
        (poso dd)
        (== `(,a ,ad . ,dd) n)
        (exp2 n &apos;() q)
        (fresh (s)
          (splito n dd r s))))
     ((fresh (a ad add ddd)
        (conde
          ((== &apos;(1 1) b))
          ((== `(,a ,ad ,add . ,ddd) b))))
      (&lt;lo b n)
      (fresh (bw1 bw nw nw1 ql1 ql s)
        (exp2 b &apos;() bw1)
        (pluso bw1 &apos;(1) bw)
        (&lt;lo q n)
        (fresh (q1 bwq1)
          (pluso q &apos;(1) q1)
          (*o bw q1 bwq1)
          (&lt;o nw1 bwq1))
          (exp2 n &apos;() nw1)
          (pluso nw1 &apos;(1) nw)
          (/o nw bw ql1 s)
          (pluso ql &apos;(1) ql1)
          (&lt;=lo ql q)
          (fresh (bql qh s qdh qd)
            (repeated-mul b ql bql)
            (/o nw bw1 qh s)
            (pluso ql qdh qh)
            (pluso ql qd q)
            (&lt;=o qd qdh)
            (fresh (bqd bq1 bq)
              (repeated-mul b qd bqd)
              (*o bql bqd bq)
              (*o b bq bq1)
              (pluso bq r n)
              (&lt;o n bq1))))))))

(define exp2
  (lambda (n b q)
    (conde
      ((== &apos;(1) n) (== &apos;() q))
      ((&gt;1o n) (== &apos;(1) q)
       (fresh (s)
         (splito n b s &apos;(1))))
      ((fresh (q1 b2)
         (== `(0 . ,q1) q)
         (poso q1)
         (&lt;lo b n)
         (appendo b `(1 . ,b) b2)
         (exp2 n b2 q1)))
      ((fresh (q1 nh b2 s)
         (== `(1 . ,q1) q)
         (poso q1)
         (poso nh)
         (splito n b s nh)
         (appendo b `(1 . ,b) b2)
         (exp2 nh b2 q1))))))

(define repeated-mul
  (lambda (n q nq)
    (conde
      ((poso n) (== &apos;() q) (== &apos;(1) nq))
      ((== &apos;(1) q) (== n nq))
      ((&gt;1o q)
       (fresh (q1 nq1)
         (pluso q1 &apos;(1) q)
         (repeated-mul n q1 nq1)
         (*o nq1 n nq))))))

(define expo
  (lambda (b q n)
    (logo n b q &apos;())))

(define-syntax test-check
  (syntax-rules ()
    ((_ title tested-expression expected-result)
     (begin
       (cout &quot;Testing &quot; title nl)
       (let* ((expected expected-result)
              (produced tested-expression))
         (or (equal? expected produced)
             (errorf &apos;test-check
                     &quot;Failed: ~a~%Expected: ~a~%Computed: ~a~%&quot;
                     &apos;tested-expression expected produced)))))))

(define max-ticks 10)
;;; Will sez:  Uncomment the following line to properly test divergent code.
;;; (define max-ticks 10)
(define max-ticks 10)
;;; Will sez:  Uncomment the following line to properly test divergent code.
;;; (define max-ticks 10000000)

(define-syntax test-divergence
  (syntax-rules ()
    ((_ title tested-expression)
     (let ((max-ticks 1000000))
       (printf &quot;Testing ~s (engine with ~s ticks fuel)\n&quot; title max-ticks)
       ((make-engine (lambda () tested-expression))
        max-ticks
        (lambda (t v)
          (error title &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
        (lambda (e^) (void)))))))


;;; Redefine &apos;test-check&apos; to make the file load quickly.
&apos;(define-syntax test-check
   (syntax-rules ()
     ((_ title tested-expression expected-result)
      (if #f #f))))

(define nl (string #\newline))

(define (cout . args)
  (for-each (lambda (x)
              (if (procedure? x) (x) (display x)))
            args))

(define errorf
  (lambda (tag . args)
    (printf &quot;Failed: ~s: ~%&quot; tag)
    (apply printf args)
    (error &apos;WiljaCodeTester &quot;That&apos;s all, folks!&quot;)))

;;;  Max fuel for engines
(define max-ticks 10)
;;; Will sez:  Uncomment the following line to properly test divergent code.
;;; (define max-ticks 10000000)


(define-syntax run1 (syntax-rules () ((_ (x) g0 g ...) (run 1 (x) g0 g ...))))
(define-syntax run2 (syntax-rules () ((_ (x) g0 g ...) (run 2 (x) g0 g ...))))
(define-syntax run3 (syntax-rules () ((_ (x) g0 g ...) (run 3 (x) g0 g ...))))
(define-syntax run4 (syntax-rules () ((_ (x) g0 g ...) (run 4 (x) g0 g ...))))
(define-syntax run5 (syntax-rules () ((_ (x) g0 g ...) (run 5 (x) g0 g ...))))
(define-syntax run6 (syntax-rules () ((_ (x) g0 g ...) (run 6 (x) g0 g ...))))
(define-syntax run7 (syntax-rules () ((_ (x) g0 g ...) (run 7 (x) g0 g ...))))
(define-syntax run8 (syntax-rules () ((_ (x) g0 g ...) (run 8 (x) g0 g ...))))
(define-syntax run9 (syntax-rules () ((_ (x) g0 g ...) (run 9 (x) g0 g ...))))
(define-syntax run10 (syntax-rules () ((_ (x) g0 g ...) (run 10 (x) g0 g ...))))

(define-syntax run11 (syntax-rules () ((_ (x) g0 g ...) (run 11 (x) g0 g ...))))
(define-syntax run12 (syntax-rules () ((_ (x) g0 g ...) (run 12 (x) g0 g ...))))
(define-syntax run13 (syntax-rules () ((_ (x) g0 g ...) (run 13 (x) g0 g ...))))
(define-syntax run14 (syntax-rules () ((_ (x) g0 g ...) (run 14 (x) g0 g ...))))
(define-syntax run15 (syntax-rules () ((_ (x) g0 g ...) (run 15 (x) g0 g ...))))
(define-syntax run16 (syntax-rules () ((_ (x) g0 g ...) (run 16 (x) g0 g ...))))
(define-syntax run17 (syntax-rules () ((_ (x) g0 g ...) (run 17 (x) g0 g ...))))
(define-syntax run18 (syntax-rules () ((_ (x) g0 g ...) (run 18 (x) g0 g ...))))
(define-syntax run19 (syntax-rules () ((_ (x) g0 g ...) (run 19 (x) g0 g ...))))
(define-syntax run20 (syntax-rules () ((_ (x) g0 g ...) (run 20 (x) g0 g ...))))

(define-syntax run21 (syntax-rules () ((_ (x) g0 g ...) (run 21 (x) g0 g ...))))
(define-syntax run22 (syntax-rules () ((_ (x) g0 g ...) (run 22 (x) g0 g ...))))
(define-syntax run23 (syntax-rules () ((_ (x) g0 g ...) (run 23 (x) g0 g ...))))
(define-syntax run24 (syntax-rules () ((_ (x) g0 g ...) (run 24 (x) g0 g ...))))
(define-syntax run25 (syntax-rules () ((_ (x) g0 g ...) (run 25 (x) g0 g ...))))
(define-syntax run26 (syntax-rules () ((_ (x) g0 g ...) (run 26 (x) g0 g ...))))
(define-syntax run27 (syntax-rules () ((_ (x) g0 g ...) (run 27 (x) g0 g ...))))
(define-syntax run28 (syntax-rules () ((_ (x) g0 g ...) (run 28 (x) g0 g ...))))
(define-syntax run29 (syntax-rules () ((_ (x) g0 g ...) (run 29 (x) g0 g ...))))
(define-syntax run30 (syntax-rules () ((_ (x) g0 g ...) (run 30 (x) g0 g ...))))

(define-syntax run31 (syntax-rules () ((_ (x) g0 g ...) (run 31 (x) g0 g ...))))
(define-syntax run32 (syntax-rules () ((_ (x) g0 g ...) (run 32 (x) g0 g ...))))
(define-syntax run33 (syntax-rules () ((_ (x) g0 g ...) (run 33 (x) g0 g ...))))
(define-syntax run34 (syntax-rules () ((_ (x) g0 g ...) (run 34 (x) g0 g ...))))
(define-syntax run35 (syntax-rules () ((_ (x) g0 g ...) (run 35 (x) g0 g ...))))
(define-syntax run36 (syntax-rules () ((_ (x) g0 g ...) (run 36 (x) g0 g ...))))
(define-syntax run37 (syntax-rules () ((_ (x) g0 g ...) (run 37 (x) g0 g ...))))
(define-syntax run38 (syntax-rules () ((_ (x) g0 g ...) (run 38 (x) g0 g ...))))
(define-syntax run39 (syntax-rules () ((_ (x) g0 g ...) (run 39 (x) g0 g ...))))
(define-syntax run40 (syntax-rules () ((_ (x) g0 g ...) (run 40 (x) g0 g ...))))

(test-check &quot;testc11.tex-1&quot;
            (run* (q)
              fail)

            `())

(test-check &quot;testc11.tex-2&quot;
            (run* (q)
              (== #t q))

            `(#t))

(test-check &quot;testc11.tex-3&quot;
            (run* (q)
              fail
              (== #t q))

            `())

(define g fail)


(test-check &quot;testc11.tex-4&quot;
            (run* (q)
              succeed
              (== #t q))

            (list #t))

(test-check &quot;testc11.tex-5&quot;
            (run* (q)
              succeed
              (== #t q))

            `(#t))

(test-check &quot;testc11.tex-6&quot;
            (run* (r)
              succeed
              (== &apos;corn r))

            (list &apos;corn))

(test-check &quot;testc11.tex-7&quot;
            (run* (r)
              succeed
              (== &apos;corn r))

            `(corn))

(test-check &quot;testc11.tex-8&quot;
            (run* (r)
              fail
              (== &apos;corn r))

            `())

(test-check &quot;testc11.tex-9&quot;
            (run* (q)
              succeed
              (== #f q))

            `(#f))

(test-check &quot;testc11.tex-10&quot;
            (run* (x)
              (let ((x #f))
                (== #t x)))

            &apos;())

(test-check &quot;testc11.tex-11&quot;
            (run* (q)
              (fresh (x)
                (== #t x)
                (== #t q)))

            (list #t))

(run* (q)
  (fresh (x)
    (== #t x)
    (== #t q)))


(test-check &quot;testc11.tex-12&quot;
            (run* (q)
              (fresh (x)
                (== x #t)
                (== #t q)))

            (list #t))

(test-check &quot;testc11.tex-13&quot;
            (run* (q)
              (fresh (x)
                (== x #t)
                (== q #t)))

            (list #t))

(test-check &quot;testc11.tex-14&quot;
            (run* (x)
              succeed)

            (list `_.0))

(test-check &quot;testc11.tex-15&quot;
            (run* (x)
              (let ((x #f))
                (fresh (x)
                  (== #t x))))

            `(_.0))

(test-check &quot;testc11.tex-16&quot;
            (run* (r)
              (fresh (x y)
                (== (cons x (cons y &apos;())) r)))

            (list `(_.0 _.1)))

(test-check &quot;testc11.tex-17&quot;
            (run* (s)
              (fresh (t u)
                (== (cons t (cons u &apos;())) s)))

            (list `(_.0 _.1)))

(test-check &quot;testc11.tex-18&quot;
            (run* (r)
              (fresh (x)
                (let ((y x))
                  (fresh (x)
                    (== (cons y (cons x (cons y &apos;()))) r)))))

            (list `(_.0 _.1 _.0)))

(test-check &quot;testc11.tex-19&quot;
            (run* (r)
              (fresh (x)
                (let ((y x))
                  (fresh (x)
                    (== (cons x (cons y (cons x &apos;()))) r)))))

            (list `(_.0 _.1 _.0)))

(test-check &quot;testc11.tex-20&quot;
            (run* (q)
              (== #f q)
              (== #t q))

            `())

(test-check &quot;testc11.tex-21&quot;
            (run* (q)
              (== #f q)
              (== #f q))

            &apos;(#f))

(test-check &quot;testc11.tex-22&quot;
            (run* (q)
              (let ((x q))
                (== #t x)))

            (list #t))

(test-check &quot;testc11.tex-23&quot;
            (run* (r)
              (fresh (x)
                (== x r)))

            (list `_.0))

(test-check &quot;testc11.tex-24&quot;
            (run* (q)
              (fresh (x)
                (== #t x)
                (== x q)))

            (list #t))

(test-check &quot;testc11.tex-25&quot;
            (run* (q)
              (fresh (x)
                (== x q)
                (== #t x)))

            (list #t))

(run* (q)
  (fresh (x)
    (== #t x)
    (== x q)))


(test-check &quot;testc11.tex-26&quot;
            (run* (q)
              (fresh (x)
                (== (eq? x q) q)))


            (list #f))


(test-check &quot;testc11.tex-27&quot;
            (run* (q)
              (let ((x q))
                (fresh (q)
                  (== (eq? x q) x))))

            (list #f))

(test-check &quot;testc11.tex-28&quot;
            (cond
             (#f #t)
             (#t #f))

            #f)

(test-check &quot;testc11.tex-29&quot;
            (cond
             (#f succeed)
             (#t fail))


            fail)


(test-check &quot;testc13.tex-fail1&quot; (run* (q)


                                  (conde
                                    (fail succeed)
                                    (succeed fail))


                                  ) &apos;())


(test-check &quot;testc13.tex-succeed1&quot; (not (null? (run* (q)


                                                 (conde
                                                   (fail fail)
                                                   (succeed succeed))


                                                 ))) #t)


(test-check &quot;testc13.tex-succeed2&quot; (not (null? (run* (q)


                                                 (conde
                                                   (succeed succeed)
                                                   (succeed fail))


                                                 ))) #t)


(test-check &quot;testc11.tex-30&quot;
            (run* (x)
              (conde
                ((== &apos;olive x) succeed)
                ((== &apos;oil x) succeed)))

            `(olive oil))

(test-check &quot;testc11.tex-31&quot;
            (run1 (x)
                  (conde
                    ((== &apos;olive x) succeed)
                    ((== &apos;oil x) succeed)))

            `(olive))

(test-check &quot;testc11.tex-32&quot;
            (run* (x)
              (conde
                ((== &apos;virgin x) fail)
                ((== &apos;olive x) succeed)
                (succeed succeed)
                ((== &apos;oil x) succeed)))

            `(olive _.0 oil))

(test-check &quot;testc13.tex-conde1&quot; (run* (x)


                                   (conde
                                     ((== &apos;olive x) succeed)
                                     (succeed succeed)
                                     ((== &apos;oil x) succeed))


                                   ) `(olive _.0 oil))


(test-check &quot;testc11.tex-33&quot;
            (run2 (x)
                  (conde
                    ((== &apos;extra x) succeed)
                    ((== &apos;virgin x) fail)
                    ((== &apos;olive x) succeed)
                    ((== &apos;oil x) succeed)))

            `(extra olive))

(test-check &quot;testc11.tex-34&quot;
            (run* (r)
              (fresh (x y)
                (== &apos;split x)
                (== &apos;pea y)
                (== (cons x (cons y &apos;())) r)))

            (list `(split pea)))

(test-check &quot;testc11.tex-35&quot;
            (run* (r)
              (fresh (x y)
                (conde
                  ((== &apos;split x) (== &apos;pea y))
                  ((== &apos;navy x) (== &apos;bean y)))
                (== (cons x (cons y &apos;())) r)))

            `((split pea) (navy bean)))

(test-check &quot;testc11.tex-36&quot;
            (run* (r)
              (fresh (x y)
                (conde
                  ((== &apos;split x) (== &apos;pea y))
                  ((== &apos;navy x) (== &apos;bean y)))
                (== (cons x (cons y (cons &apos;soup &apos;()))) r)))

            `((split pea soup) (navy bean soup)))

(define teacupo
  (lambda (x)
    (conde
      ((== &apos;tea x) succeed)
      ((== &apos;cup x) succeed))))


(test-check &quot;testc11.tex-37&quot;
            (run* (x)
              (teacupo x))

            `(tea cup))

(test-check &quot;testc11.tex-38&quot;
            (run* (r)
              (fresh (x y)
                (conde
                  ((teacupo x) (== #t y) succeed)
                  ((== #f x) (== #t y)))
                (== (cons x (cons y &apos;())) r)))

            `((#f #t) (tea #t) (cup #t)))

(test-check &quot;testc11.tex-39&quot;
            (run* (r)
              (fresh (x y z)
                (conde
                  ((== y x) (fresh (x) (== z x)))
                  ((fresh (x) (== y x)) (== z x)))
                (== (cons y (cons z &apos;())) r)))

            `((_.0 _.1) (_.0 _.1)))

(test-check &quot;testc11.tex-40&quot;
            (run* (r)
              (fresh (x y z)
                (conde
                  ((== y x) (fresh (x) (== z x)))
                  ((fresh (x) (== y x)) (== z x)))
                (== #f x)
                (== (cons y (cons z &apos;())) r)))

            `((#f _.0) (_.0 #f)))

(test-check &quot;testc11.tex-41&quot;
            (run* (q)
              (let ((a (== #t q))
                    (b (== #f q)))
                b))

            &apos;(#f))

(test-check &quot;testc11.tex-42&quot;
            (run* (q)
              (let ((a (== #t q))
                    (b (fresh (x)
                         (== x q)
                         (== #f x)))
                    (c (conde
                         ((== #t q) succeed)
                         (succeed (== #f q)))))
                b))

            &apos;(#f))

(test-check &quot;testc12.tex-1&quot;
            (let ((x (lambda (a) a))
                  (y &apos;c))
              (x y))

            &apos;c)

(test-check &quot;testc12.tex-2&quot;
            (run* (r)
              (fresh (y x)
                (== `(,x ,y) r)))

            (list `(_.0 _.1)))

(test-check &quot;testc12.tex-3&quot;
            (run* (r)
              (fresh (v w)
                (== (let ((x v) (y w)) `(,x ,y)) r)))

            `((_.0 _.1)))

(test-check &quot;testc12.tex-4&quot;
            (car `(grape raisin pear))

            `grape)

(test-check &quot;testc12.tex-5&quot;
            (car `(a c o r n))

            &apos;a)


(define caro
  (lambda (p a)
    (fresh (d)
      (== (cons a d) p))))


(test-check &quot;testc12.tex-6&quot;
            (run* (r)
              (caro `(a c o r n) r))

            (list &apos;a))

(test-check &quot;testc12.tex-7&quot; &apos;a

            (car

             `(a c o r n)

             ))


(test-check &quot;testc12.tex-8&quot;
            (run* (q)
              (caro `(a c o r n) &apos;a)
              (== #t q))

            (list #t))

(test-check &quot;testc12.tex-9&quot; &apos;a

            (car

             `(a c o r n)

             ))


(test-check &quot;testc12.tex-10&quot;
            (run* (r)
              (fresh (x y)
                (caro `(,r ,y) x)
                (== &apos;pear x)))

            (list &apos;pear))


(test-check &quot;testc12.tex-11&quot;
            (cons
             (car `(grape raisin pear))
             (car `((a) (b) (c))))

            `(grape a))

(test-check &quot;testc12.tex-12&quot;
            (run* (r)
              (fresh (x y)
                (caro `(grape raisin pear) x)
                (caro `((a) (b) (c)) y)
                (== (cons x y) r)))

            (list `(grape a)))

(test-check &quot;testc12.tex-13&quot;
            (cdr `(grape raisin pear))

            `(raisin pear))

(test-check &quot;testc12.tex-14&quot;
            (car (cdr `(a c o r n)))

            &apos;c)


(define cdro
  (lambda (p d)
    (fresh (a)
      (== (cons a d) p))))


(test-check &quot;testc12.tex-15&quot;
            (run* (r)
              (fresh (v)
                (cdro `(a c o r n) v)
                (caro v r)))

            (list &apos;c))


(test-check &quot;testc12.tex-16&quot;
            (cons
             (cdr `(grape raisin pear))
             (car `((a) (b) (c))))

            `((raisin pear) a))

(test-check &quot;testc12.tex-17&quot;
            (run* (r)
              (fresh (x y)
                (cdro `(grape raisin pear) x)
                (caro `((a) (b) (c)) y)
                (== (cons x y) r)))

            (list `((raisin pear) a)))

(test-check &quot;testc12.tex-18&quot;
            (run* (q)
              (cdro &apos;(a c o r n) &apos;(c o r n))
              (== #t q))

            (list #t))

(test-check &quot;testc12.tex-19&quot; `(c o r n)

            (cdr

             &apos;(a c o r n)

             ))


(test-check &quot;testc12.tex-20&quot;
            (run* (x)
              (cdro &apos;(c o r n) `(,x r n)))

            (list &apos;o))

(test-check &quot;testc12.tex-21&quot; `(o r n)

            (cdr

             `(c o r n)

             ))


(test-check &quot;testc12.tex-22&quot;
            (run* (l)
              (fresh (x)
                (cdro l &apos;(c o r n))
                (caro l x)
                (== &apos;a x)))

            (list `(a c o r n)))


(define conso
  (lambda (a d p)
    (== (cons a d) p)))


(test-check &quot;testc12.tex-23&quot;
            (run* (l)
              (conso &apos;(a b c) &apos;(d e) l))

            (list `((a b c) d e)))

(test-check &quot;testc12.tex-24&quot;
            (run* (x)
              (conso x &apos;(a b c) &apos;(d a b c)))

            (list &apos;d))

(test-check &quot;testc12.tex-25&quot; (cons &apos;d &apos;(a b c))
            `(d a b c))

(test-check &quot;testc12.tex-26&quot;
            (run* (r)
              (fresh (x y z)
                (== `(e a d ,x) r)
                (conso y `(a ,z c) r)))

            (list `(e a d c)))

(test-check &quot;testc12.tex-27&quot;
            (run* (x)
              (conso x `(a ,x c) `(d a ,x c)))

            (list &apos;d))

(define x &apos;d)


(test-check &quot;testc12.tex-28&quot; (cons x `(a ,x c))
            `(d a ,x c))

(test-check &quot;testc12.tex-29&quot;
            (run* (l)
              (fresh (x)
                (== `(d a ,x c) l)
                (conso x `(a ,x c) l)))

            (list `(d a d c)))

(test-check &quot;testc12.tex-30&quot;
            (run* (l)
              (fresh (x)
                (conso x `(a ,x c) l)
                (== `(d a ,x c) l)))

            (list `(d a d c)))


(test-check &quot;testc12.tex-31&quot;
            (run* (l)
              (fresh (d x y w s)
                (conso w &apos;(a n s) s)
                (cdro l s)
                (caro l x)
                (== &apos;b x)
                (cdro l d)
                (caro d y)
                (== &apos;e y)))

            (list `(b e a n s)))

(test-check &quot;testc12.tex-32&quot;
            (null? `(grape raisin pear))

            #f)

(test-check &quot;testc12.tex-33&quot;
            (null? &apos;())

            #t)


(define nullo
  (lambda (x)
    (== &apos;() x)))


(test-check &quot;testc12.tex-34&quot;
            (run* (q)
              (nullo `(grape raisin pear))
              (== #t q))

            `())

(test-check &quot;testc12.tex-35&quot;
            (run* (q)
              (nullo &apos;())
              (== #t q))

            `(#t))

(test-check &quot;testc12.tex-36&quot;
            (run* (x)
              (nullo x))

            `(()))


(test-check &quot;testc12.tex-37&quot;
            (eq? &apos;pear &apos;plum)

            #f)

(test-check &quot;testc12.tex-38&quot;
            (eq? &apos;plum &apos;plum)

            #t)


(define eqo
  (lambda (x y)
    (== x y)))


(test-check &quot;testc12.tex-39&quot;
            (run* (q)
              (eqo &apos;pear &apos;plum)
              (== #t q))

            `())

(test-check &quot;testc12.tex-40&quot;
            (run* (q)
              (eqo &apos;plum &apos;plum)
              (== #t q))

            `(#t))


(test-check &quot;testc12.tex-41&quot;
            (pair? `((split) . pea))

            #t)

(test-check &quot;testc12.tex-42&quot;
            (pair? &apos;())

            #f)

(test-check &quot;testc12.tex-43&quot;
            (car `(pear))

            `pear)

(test-check &quot;testc12.tex-44&quot;
            (cdr `(pear))

            `())

(test-check &quot;testc12.tex-45&quot;
            (cons `(split) &apos;pea)

            `((split) . pea))

(test-check &quot;testc12.tex-46&quot;
            (run* (r)
              (fresh (x y)
                (== (cons x (cons y &apos;salad)) r)))

            (list `(_.0 _.1 . salad)))

(define pairo
  (lambda (p)
    (fresh (a d)
      (conso a d p))))


(test-check &quot;testc12.tex-47&quot;
            (run* (q)
              (pairo (cons q q))
              (== #t q))

            `(#t))

(test-check &quot;testc12.tex-48&quot;
            (run* (q)
              (pairo &apos;())
              (== #t q))

            `())

(test-check &quot;testc12.tex-49&quot;
            (run* (q)
              (pairo &apos;pair)
              (== #t q))

            `())

(test-check &quot;testc12.tex-50&quot;
            (run* (x)
              (pairo x))

            (list `(_.0 . _.1)))

(test-check &quot;testc12.tex-51&quot;
            (run* (r)
              (pairo (cons r &apos;pear)))

            (list `_.0))

(define new-list?
  (lambda (l)
    (cond
     ((null? l) #t)
     ((pair? l) (new-list? (cdr l)))
     (else #f))))


(test-check &quot;testc14.tex-1&quot;
            (new-list? `((a) (a b) c))

            #t)

(test-check &quot;testc14.tex-2&quot;
            (new-list? `())

            #t)

(test-check &quot;testc14.tex-3&quot;
            (new-list? &apos;s)

            #f)

(test-check &quot;testc14.tex-4&quot;
            (new-list? `(d a t e . s))

            #f)

(define listo
  (lambda (l)
    (conde
      ((nullo l) succeed)
      ((pairo l)
       (fresh (d)
         (cdro l d)
         (listo d)))
      ((== #f #f) fail))))


(define listo
  (lambda (l)
    (conde
      ((nullo l) succeed)
      ((pairo l)
       (fresh (d)
         (cdro l d)
         (listo d)))
      (succeed fail))))


(define listo
  (lambda (l)
    (conde
      ((nullo l) succeed)
      ((pairo l)
       (fresh (d)
         (cdro l d)
         (listo d))))))


(test-check &quot;testc14.tex-5&quot;
            (run* (x)
              (listo `(a b ,x d)))

            (list `_.0))

(test-check &quot;testc14.tex-6&quot;
            (run1 (x)
                  (listo `(a b c . ,x)))

            (list `()))
(define e (make-engine (lambda ()
                         (run* (x)
                           (listo `(a b c . ,x)))
                         )))
(printf &quot;Testing testc14.tex-7  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc14.tex-7 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(test-check &quot;testc14.tex-8&quot;
            (run5 (x)
                  (listo `(a b c . ,x)))


            `(()
              (_.0)
              (_.0 _.1)
              (_.0 _.1 _.2)
              (_.0 _.1 _.2 _.3))
            )

(define lol?
  (lambda (l)
    (cond
     ((null? l) #t)
     ((new-list? (car l)) (lol? (cdr l)))
     (else #f))))


(define lolo
  (lambda (l)
    (conde
      ((nullo l) succeed)
      ((fresh (a)
         (caro l a)
         (listo a))
       (fresh (d)
         (cdro l d)
         (lolo d))))))


(test-check &quot;testc14.tex-9&quot;
            (run1 (l)
                  (lolo l))

            `(()))

(test-check &quot;testc14.tex-10&quot;
            (run* (q)
              (fresh (x y)
                (lolo `((a b) (,x c) (d ,y)))
                (== #t q)))

            (list #t))

(test-check &quot;testc14.tex-11&quot;
            (run1 (q)
                  (fresh (x)
                    (lolo `((a b) . ,x))
                    (== #t q)))

            (list #t))

(test-check &quot;testc14.tex-12&quot;
            (run1 (x)
                  (lolo `((a b) (c d) . ,x)))

            `(()))

(test-check &quot;testc14.tex-13&quot;
            (run5 (x)
                  (lolo `((a b) (c d) . ,x)))


            `(()
              (())
              ((_.0))
              (() ())
              ((_.0 _.1)))
            )

(define twinso
  (lambda (s)
    (fresh (x y)
      (conso x y s)
      (conso x &apos;() y))))


(test-check &quot;testc14.tex-14&quot;
            (run* (q)
              (twinso &apos;(tofu tofu))
              (== #t q))

            (list #t))

(test-check &quot;testc14.tex-15&quot;
            (run* (z)
              (twinso `(,z tofu)))

            (list `tofu))

(define loto
  (lambda (l)
    (conde
      ((nullo l) succeed)
      ((fresh (a)
         (caro l a)
         (twinso a))
       (fresh (d)
         (cdro l d)
         (loto d))))))


(test-check &quot;testc14.tex-16&quot;
            (run1 (z)
                  (loto `((g g) . ,z)))

            (list `()))

(test-check &quot;testc14.tex-17&quot;
            (run5 (z)
                  (loto `((g g) . ,z)))


            &apos;(()
              ((_.0 _.0))
              ((_.0 _.0) (_.1 _.1))
              ((_.0 _.0) (_.1 _.1) (_.2 _.2))
              ((_.0 _.0) (_.1 _.1) (_.2 _.2) (_.3 _.3)))
            )

(test-check &quot;testc14.tex-18&quot;
            (run5 (r)
                  (fresh (w x y z)
                    (loto `((g g) (e ,w) (,x ,y) . ,z))
                    (== `(,w (,x ,y) ,z) r)))


            &apos;((e (_.0 _.0) ())
              (e (_.0 _.0) ((_.1 _.1)))
              (e (_.0 _.0) ((_.1 _.1) (_.2 _.2)))
              (e (_.0 _.0) ((_.1 _.1) (_.2 _.2) (_.3 _.3)))
              (e (_.0 _.0) ((_.1 _.1) (_.2 _.2) (_.3 _.3) (_.4 _.4))))
            )

(test-check &quot;testc14.tex-19&quot;
            (run3 (out)
                  (fresh (w x y z)
                    (== `((g g) (e ,w) (,x ,y) . ,z) out)
                    (loto out)))


            `(((g g) (e e) (_.0 _.0))
              ((g g) (e e) (_.0 _.0) (_.1 _.1))
              ((g g) (e e) (_.0 _.0) (_.1 _.1) (_.2 _.2)))
            )

(define listofo
  (lambda (predo l)
    (conde
      ((nullo l) succeed)
      ((fresh (a)
         (caro l a)
         (predo a))
       (fresh (d)
         (cdro l d)
         (listofo predo d))))))


(test-check &quot;testc14.tex-20&quot;
            (run3 (out)
                  (fresh (w x y z)
                    (== `((g g) (e ,w) (,x ,y) . ,z) out)
                    (listofo twinso out)))


            `(((g g) (e e) (_.0 _.0))
              ((g g) (e e) (_.0 _.0) (_.1 _.1))
              ((g g) (e e) (_.0 _.0) (_.1 _.1) (_.2 _.2)))
            )

(define loto
  (lambda (l)
    (listofo twinso l)))


(define member?
  (lambda (x l)
    (cond
     ((null? l) #f)
     ((eq? (car l) x) #t)
     (else (member? x (cdr l))))))


(test-check &quot;testc14.tex-21&quot;
            (member? &apos;olive `(virgin olive oil))

            #t)

(define membero
  (lambda (x l)
    (conde
      ((nullo l) fail)
      ((fresh (a)
         (caro l a)
         (== a x))
       succeed)
      (succeed
       (fresh (d)
         (cdro l d)
         (membero x d))))))


(test-check &quot;testc14.tex-22&quot;
            (run* (q)
              (membero &apos;olive `(virgin olive oil))
              (== #t q))

            (list #t))

(test-check &quot;testc14.tex-23&quot;
            (run1 (y)
                  (membero y `(hummus with pita)))

            (list `hummus))

(test-check &quot;testc14.tex-24&quot;
            (run1 (y)
                  (membero y `(with pita)))

            (list `with))

(test-check &quot;testc14.tex-25&quot;
            (run1 (y)
                  (membero y `(pita)))

            (list `pita))

(test-check &quot;testc14.tex-26&quot;
            (run* (y)
              (membero y `()))

            `())

(test-check &quot;testc14.tex-27&quot;
            (run* (y)
              (membero y `(hummus with pita)))

            `(hummus with pita))

(test-check &quot;testc14.tex-28&quot;
            (run* (x)
              (membero &apos;e `(pasta ,x fagioli)))

            (list `e))

(test-check &quot;testc14.tex-29&quot;
            (run1 (x)
                  (membero &apos;e `(pasta e ,x fagioli)))

            (list `_.0))

(test-check &quot;testc14.tex-30&quot;
            (run1 (x)
                  (membero &apos;e `(pasta ,x e fagioli)))

            (list `e))

(test-check &quot;testc14.tex-31&quot;
            (run* (r)
              (fresh (x y)
                (membero &apos;e `(pasta ,x fagioli ,y))
                (== `(,x ,y) r)))

            `((e _.0) (_.0 e)))

(test-check &quot;testc14.tex-32&quot;
            (run1 (l)
                  (membero &apos;tofu l))

            `((tofu . _.0)))
(define e (make-engine (lambda ()
                         (run* (l)
                           (membero &apos;tofu l))
                         )))
(printf &quot;Testing testc14.tex-33  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc14.tex-33 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(test-check &quot;testc14.tex-34&quot;
            (run5 (l)
                  (membero &apos;tofu l))


            `((tofu . _.0)
              (_.0 tofu . _.1)
              (_.0 _.1 tofu . _.2)
              (_.0 _.1 _.2 tofu . _.3)
              (_.0 _.1 _.2 _.3 tofu . _.4))
            )

(define pmembero
  (lambda (x l)
    (conde
      ((caro l x) (cdro l &apos;()))
      ((fresh (d)
         (cdro l d)
         (pmembero x d))))))


(test-check &quot;testc14.tex-35&quot;
            (run5 (l)
                  (pmembero &apos;tofu l))


            `((tofu)
              (_.0 tofu)
              (_.0 _.1 tofu)
              (_.0 _.1 _.2 tofu)
              (_.0 _.1 _.2 _.3 tofu))
            )

(test-check &quot;testc14.tex-36&quot;
            (run* (q)
              (pmembero &apos;tofu `(a b tofu d tofu))
              (== #t q))

            `(#t))

(define pmembero
  (lambda (x l)
    (conde
      ((caro l x)
       (conde
         ((cdro l &apos;()))
         (succeed)))
      ((fresh (d)
         (cdro l d)
         (pmembero x d))))))


(test-check &quot;testc14.tex-37&quot;
            (run* (q)
              (pmembero &apos;tofu `(a b tofu d tofu))
              (== #t q))

            `(#t #t #t))

(define pmembero
  (lambda (x l)
    (conde
      ((caro l x)
       (conde
         ((cdro l &apos;()))
         ((fresh (a d)
            (cdro l `(,a . ,d))))))
      ((fresh (d)
         (cdro l d)
         (pmembero x d))))))


(test-check &quot;testc14.tex-38&quot;
            (run* (q)
              (pmembero &apos;tofu `(a b tofu d tofu))
              (== #t q))

            `(#t #t))

(test-check &quot;testc14.tex-39&quot;
            (run12 (l)
                   (pmembero &apos;tofu l))


            `((tofu)
              (tofu _.0 . _.1)
              (_.0 tofu)
              (_.0 tofu _.1 . _.2)
              (_.0 _.1 tofu)
              (_.0 _.1 tofu _.2 . _.3)
              (_.0 _.1 _.2 tofu)
              (_.0 _.1 _.2 tofu _.3 . _.4)
              (_.0 _.1 _.2 _.3 tofu)
              (_.0 _.1 _.2  _.3 tofu _.4 . _.5 )
              (_.0 _.1 _.2 _.3 _.4 tofu)
              (_.0 _.1 _.2 _.3 _.4 tofu _.5 . _.6))
            )

(define mem
  (lambda (x l)
    (cond
     ((null? l) #f)
     ((eq? (car l) x) l)
     (else (mem x (cdr l))))))


(test-check &quot;testc15.tex-1&quot;
            (mem &apos;tofu `(a b tofu d peas e))

            `(tofu d peas e))

(test-check &quot;testc15.tex-2&quot;
            (mem &apos;tofu `(a b peas d peas e))

            #f)

(test-check &quot;testc15.tex-3&quot;
            (run* (out)
              (== (mem &apos;tofu `(a b tofu d peas e)) out))

            (list `(tofu d peas e)))

(test-check &quot;testc15.tex-4&quot;
            (mem &apos;peas
                 (mem &apos;tofu `(a b tofu d peas e)))

            `(peas e))

(test-check &quot;testc15.tex-5&quot;
            (mem &apos;tofu
                 (mem &apos;tofu `(a b tofu d tofu e)))

            `(tofu d tofu e))

(test-check &quot;testc15.tex-6&quot;
            (mem &apos;tofu
                 (cdr (mem &apos;tofu `(a b tofu d tofu e))))

            `(tofu e))

(define memo
  (lambda (x l out)
    (conde
      ((nullo l) fail)
      ((fresh (a)
         (caro l a)
         (== a x))
       (== l out))
      (succeed
       (fresh (d)
         (cdro l d)
         (memo x d out))))))


(define memo
  (lambda (x l out)
    (conde
      ((fresh (a)
         (caro l a)
         (== a x))
       (== l out))
      ((fresh (d)
         (cdro l d)
         (memo x d out))))))


(define memo
  (lambda (x l out)
    (conde
      ((caro l x) (== l out))
      ((fresh (d)
         (cdro l d)
         (memo x d out))))))


(test-check &quot;testc15.tex-7&quot;
            (run1 (out)
                  (memo &apos;tofu `(a b tofu d tofu e) out))

            `((tofu d tofu e)))

(test-check &quot;testc15.tex-8&quot;
            (run1 (out)
                  (fresh (x)
                    (memo &apos;tofu `(a b ,x d tofu e) out)))

            `((tofu d tofu e)))

(test-check &quot;testc15.tex-9&quot;
            (run* (r)
              (memo r
                    `(a b tofu d tofu e)
                    `(tofu d tofu e)))

            (list `tofu))

(test-check &quot;testc15.tex-10&quot;
            (run* (q)
              (memo &apos;tofu &apos;(tofu e) &apos;(tofu e))
              (== #t q))

            (list #t))

(test-check &quot;testc15.tex-11&quot;
            (run* (q)
              (memo &apos;tofu &apos;(tofu e) &apos;(tofu))
              (== #t q))

            `())

(test-check &quot;testc15.tex-12&quot;
            (run* (x)
              (memo &apos;tofu &apos;(tofu e) `(,x e)))

            (list `tofu))

(test-check &quot;testc15.tex-13&quot;
            (run* (x)
              (memo &apos;tofu &apos;(tofu e) `(peas ,x)))

            `())

(test-check &quot;testc15.tex-14&quot;
            (run* (out)
              (fresh (x)
                (memo &apos;tofu `(a b ,x d tofu e) out)))

            `((tofu d tofu e) (tofu e)))

(test-check &quot;testc15.tex-15&quot;
            (run12 (z)
                   (fresh (u)
                     (memo &apos;tofu `(a b tofu d tofu e . ,z) u)))


            `(_.0
              _.0
              (tofu . _.0)
              (_.0 tofu . _.1)
              (_.0 _.1 tofu . _.2)
              (_.0 _.1 _.2 tofu . _.3)
              (_.0 _.1 _.2 _.3 tofu . _.4)
              (_.0 _.1 _.2 _.3 _.4 tofu . _.5)
              (_.0 _.1 _.2 _.3 _.4 _.5 tofu . _.6)
              (_.0 _.1 _.2 _.3 _.4 _.5 _.6 tofu . _.7)
              (_.0 _.1 _.2 _.3 _.4 _.5 _.6 _.7 tofu . _.8)
              (_.0 _.1 _.2 _.3 _.4 _.5 _.6 _.7 _.8 tofu . _.9))
            )

(define rember
  (lambda (x l)
    (cond
     ((null? l) &apos;())
     ((eq? (car l) x) (cdr l))
     (else
      (cons (car l)
            (rember x (cdr l)))))))


(test-check &quot;testc15.tex-16&quot;
            (rember &apos;peas &apos;(a b peas d peas e))

            `(a b d peas e))

(define rembero
  (lambda (x l out)
    (conde
      ((nullo l) (== &apos;() out))
      ((fresh (a)
         (caro l a)
         (== a x))
       (cdro l out))
      ((fresh (res)
         (fresh (d)
           (cdro l d)
           (rembero x d res))
         (fresh (a)
           (caro l a)
           (conso a res out)))))))


(define rembero
  (lambda (x l out)
    (conde
      ((nullo l) (== &apos;() out))
      ((caro l x) (cdro l out))
      ((fresh (res)
         (fresh (d)
           (cdro l d)
           (rembero x d res))
         (fresh (a)
           (caro l a)
           (conso a res out)))))))


(fresh (res)
  (fresh (d)
    (cdro l d)
    (rembero x d res))
  (fresh (a)
    (caro l a)
    (conso a res out)))


(fresh (a d res)
  (cdro l d)
  (rembero x d res)
  (caro l a)
  (conso a res out))


(define rembero
  (lambda (x l out)
    (conde
      ((nullo l) (== &apos;() out))
      ((caro l x) (cdro l out))
      (


       (fresh (a d res)
         (conso a d l)
         (rembero x d res)
         (conso a res out))


       ))))


(test-check &quot;testc15.tex-17&quot;
            (run1 (out)
                  (fresh (y)
                    (rembero &apos;peas `(a b ,y d peas e) out)))

            `((a b d peas e)))

(test-check &quot;testc15.tex-18&quot;
            (run* (out)
              (fresh (y z)
                (rembero y `(a b ,y d ,z e) out)))


            `((b a d _.0 e)
              (a b d _.0 e)
              (a b d _.0 e)
              (a b d _.0 e)
              (a b _.0 d e)
              (a b e d _.0)
              (a b _.0 d _.1 e))
            )

(test-check &quot;testc15.tex-19&quot;
            (run* (r)
              (fresh (y z)
                (rembero y `(,y d ,z e) `(,y d e))
                (== `(,y ,z) r)))


            `((d d)
              (d d)
              (_.0 _.0)
              (e e))
            )

(test-check &quot;testc15.tex-20&quot;
            (run13 (w)
                   (fresh (y z out)
                     (rembero y `(a b ,y d ,z . ,w) out)))


            `(_.0
              _.0
              _.0
              _.0
              _.0
              ()
              (_.0 . _.1)
              (_.0)
              (_.0 _.1 . _.2)
              (_.0 _.1)
              (_.0 _.1 _.2 . _.3)
              (_.0 _.1 _.2)
              (_.0 _.1 _.2 _.3 . _.4))
            )

(define surpriseo
  (lambda (s)
    (rembero s &apos;(a b c) &apos;(a b c))))


(test-check &quot;testc15.tex-21&quot;
            (run* (r)
              (== &apos;d r)
              (surpriseo r))

            (list &apos;d))

(test-check &quot;testc15.tex-22&quot;
            (run* (r)
              (surpriseo r))

            `(_.0))

(test-check &quot;testc15.tex-23&quot;
            (run* (r)
              (== &apos;b r)
              (surpriseo r))

            `(b))

(define new-append
  (lambda (l s)
    (cond
     ((null? l) s)
     (else (cons (car l)
                 (new-append (cdr l) s))))))


(test-check &quot;testc16.tex-1&quot;
            (new-append `(a b c) `(d e))

            `(a b c d e))

(test-check &quot;testc16.tex-2&quot;
            (new-append &apos;(a b c) &apos;())

            `(a b c))

(test-check &quot;testc16.tex-3&quot;
            (new-append &apos;() &apos;(d e))

            `(d e))

(test-check &quot;testc16.tex-4&quot;
            (new-append &apos;(d e) &apos;a)

            `(d e . a))

(define appendo
  (lambda (l s out)
    (conde
      ((nullo l) (== s out))
      ((fresh (a d res)
         (caro l a)
         (cdro l d)
         (appendo d s res)
         (conso a res out))))))


(test-check &quot;testc16.tex-5&quot;
            (run* (x)
              (appendo
               &apos;(cake)
               &apos;(tastes yummy)
               x))

            (list `(cake tastes yummy)))

(test-check &quot;testc16.tex-6&quot;
            (run* (x)
              (fresh (y)
                (appendo
                 `(cake with ice ,y)
                 &apos;(tastes yummy)
                 x)))

            (list `(cake with ice _.0 tastes yummy)))

(test-check &quot;testc16.tex-7&quot;
            (run* (x)
              (fresh (y)
                (appendo
                 &apos;(cake with ice cream)
                 y
                 x)))

            (list `(cake with ice cream . _.0)))

(test-check &quot;testc16.tex-8&quot;
            (run1 (x)
                  (fresh (y)
                    (appendo `(cake with ice . ,y) &apos;(d t) x)))

            (list `(cake with ice d t)))

(test-check &quot;testc16.tex-9&quot;
            (run1 (y)
                  (fresh (x)
                    (appendo `(cake with ice . ,y) &apos;(d t) x)))


            (list &apos;()))


(define appendo
  (lambda (l s out)
    (conde
      ((nullo l) (== s out))
      ((fresh (a d res)
         (conso a d l)
         (appendo d s res)
         (conso a res out))))))


(test-check &quot;testc16.tex-10&quot;
            (run5 (x)
                  (fresh (y)
                    (appendo `(cake with ice . ,y) &apos;(d t) x)))


            `((cake with ice d t)
              (cake with ice _.0 d t)
              (cake with ice _.0 _.1 d t)
              (cake with ice _.0 _.1 _.2 d t)
              (cake with ice _.0 _.1 _.2 _.3 d t))
            )

(test-check &quot;testc16.tex-11&quot;
            (run5 (y)
                  (fresh (x)
                    (appendo `(cake with ice . ,y) &apos;(d t) x)))


            `(()
              (_.0)
              (_.0 _.1)
              (_.0 _.1 _.2)
              (_.0 _.1 _.2 _.3))
            )

(define y

  `(_.0 _.1 _.2)

  )


(test-check &quot;testc16.tex-12&quot;
            `(cake with ice . ,y)


            `(cake with ice . (_.0 _.1 _.2))
            )

(test-check &quot;testc16.tex-13&quot;
            (run5 (x)
                  (fresh (y)
                    (appendo
                     `(cake with ice . ,y)
                     `(d t . ,y)
                     x)))


            `((cake with ice d t)
              (cake with ice _.0 d t _.0)
              (cake with ice _.0 _.1 d t _.0 _.1)
              (cake with ice _.0 _.1 _.2 d t _.0 _.1 _.2)
              (cake with ice _.0 _.1 _.2 _.3 d t _.0 _.1 _.2 _.3))
            )

(test-check &quot;testc16.tex-14&quot;
            (run* (x)
              (fresh (z)
                (appendo
                 `(cake with ice cream)
                 `(d t . ,z)
                 x)))


            `((cake with ice cream d t . _.0))
            )

(test-check &quot;testc16.tex-15&quot;
            (run6 (x)
                  (fresh (y)
                    (appendo x y `(cake with ice d t))))


            `(()
              (cake)
              (cake with)
              (cake with ice)
              (cake with ice d)
              (cake with ice d t))
            )

(test-check &quot;testc16.tex-16&quot;
            (run6 (y)
                  (fresh (x)
                    (appendo x y `(cake with ice d t))))


            `((cake with ice d t)
              (with ice d t)
              (ice d t)
              (d t)
              (t)
              ())
            )

(define appendxyquestion
  (lambda ()


    (run6 (r)
          (fresh (x y)
            (appendo x y `(cake with ice d t))
            (== `(,x ,y) r)))


    ))
(define appendxyanswer


  `((() (cake with ice d t))
    ((cake) (with ice d t))
    ((cake with) (ice d t))
    ((cake with ice) (d t))
    ((cake with ice d) (t))
    ((cake with ice d t) ()))


  )
(test-check &quot;appendxy&quot;
            (appendxyquestion)
            appendxyanswer)

(define e (make-engine (lambda ()
                         (run7 (r)
                               (fresh (x y)
                                 (appendo x y `(cake with ice d t))
                                 (== `(,x ,y) r)))
                         )))
(printf &quot;Testing testc16.tex-17  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc16.tex-17 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(define appendo
  (lambda (l s out)
    (conde
      ((nullo l) (== s out))
      ((fresh (a d res)
         (conso a d l)
         (conso a res out)
         (appendo d s res))))))


(test-check &quot;testc16.tex-18&quot;
            (run7 (r)
                  (fresh (x y)
                    (appendo x y `(cake with ice d t))
                    (== `(,x ,y) r)))


            appendxyanswer)


(test-check &quot;testc16.tex-19&quot;
            (run7 (x)
                  (fresh (y z)
                    (appendo x y z)))


            `(()
              (_.0)
              (_.0 _.1)
              (_.0 _.1 _.2)
              (_.0 _.1 _.2 _.3)
              (_.0 _.1 _.2 _.3 _.4)
              (_.0 _.1 _.2 _.3 _.4 _.5))
            )

(test-check &quot;testc16.tex-20&quot;
            (run7 (y)
                  (fresh (x z)
                    (appendo x y z)))


            `(_.0
              _.0
              _.0
              _.0
              _.0
              _.0
              _.0)
            )

(test-check &quot;testc16.tex-21&quot;
            (run7 (z)
                  (fresh (x y)
                    (appendo x y z)))


            `(_.0
              (_.0 . _.1)
              (_.0 _.1 . _.2)
              (_.0 _.1 _.2 . _.3)
              (_.0 _.1 _.2 _.3 . _.4)
              (_.0 _.1 _.2 _.3 _.4 . _.5)
              (_.0 _.1 _.2 _.3 _.4 _.5 . _.6))
            )

(test-check &quot;testc16.tex-22&quot;
            (run7 (r)
                  (fresh (x y z)
                    (appendo x y z)
                    (== `(,x ,y ,z) r)))


            `((() _.0 _.0)
              ((_.0) _.1 (_.0 . _.1))
              ((_.0 _.1) _.2 (_.0 _.1 . _.2))
              ((_.0 _.1 _.2) _.3 (_.0 _.1 _.2 . _.3))
              ((_.0 _.1 _.2 _.3) _.4 (_.0 _.1 _.2 _.3 . _.4))
              ((_.0 _.1 _.2 _.3 _.4) _.5 (_.0 _.1 _.2 _.3 _.4 . _.5))
              ((_.0 _.1 _.2 _.3 _.4 _.5) _.6 (_.0 _.1 _.2 _.3 _.4 _.5 . _.6)))
            )

(define swappendo
  (lambda (l s out)
    (conde
      ((fresh (a d res)
         (conso a d l)
         (conso a res out)
         (swappendo d s res)))
      ((nullo l) (== s out)))))


(test-check &quot;testc16.tex-23&quot;
            (run7 (r)
                  (fresh (x y z)
                    (swappendo x y z)
                    (== `(,x ,y ,z) r)))


            `((() _.0 _.0)
              ((_.0) _.1 (_.0 . _.1))
              ((_.0 _.1) _.2 (_.0 _.1 . _.2))
              ((_.0 _.1 _.2) _.3 (_.0 _.1 _.2 . _.3))
              ((_.0 _.1 _.2 _.3) _.4 (_.0 _.1 _.2 _.3 . _.4))
              ((_.0 _.1 _.2 _.3 _.4) _.5 (_.0 _.1 _.2 _.3 _.4 . _.5))
              ((_.0 _.1 _.2 _.3 _.4 _.5) _.6 (_.0 _.1 _.2 _.3 _.4 _.5 . _.6)))
            )

(define unwrap
  (lambda (x)
    (cond
     ((pair? x) (unwrap (car x)))
     (else x))))


(test-check &quot;testc16.tex-24&quot;
            (unwrap &apos;((((pizza)))))

            `pizza)

(test-check &quot;testc16.tex-25&quot;
            (unwrap &apos;((((pizza pie) with)) extra cheese))

            `pizza)

(define unwrapo
  (lambda (x out)
    (conde
      ((pairo x)
       (fresh (a)
         (caro x a)
         (unwrapo a out)))
      ((== x out)))))


(test-check &quot;testc16.tex-26&quot;
            (run* (x)
              (unwrapo &apos;(((pizza))) x))


            `((((pizza)))
              ((pizza))
              (pizza)
              pizza)
            )

(test-check &quot;testc16.tex-27&quot;
            (run1 (x)
                  (unwrapo x &apos;pizza))


            `(pizza)
            )

(test-check &quot;testc16.tex-28&quot;
            (run1 (x)
                  (unwrapo `((,x)) &apos;pizza))


            `(pizza)
            )

(test-check &quot;testc16.tex-29&quot;
            (run5 (x)
                  (unwrapo x &apos;pizza))


            `(pizza
              (pizza . _.0)
              ((pizza . _.0) . _.1)
              (((pizza . _.0) . _.1) . _.2)
              ((((pizza . _.0) . _.1) . _.2) . _.3))
            )

(test-check &quot;testc16.tex-30&quot;
            (run5 (x)
                  (unwrapo x &apos;((pizza))))


            `(((pizza))
              (((pizza)) . _.0)
              ((((pizza)) . _.0) . _.1)
              (((((pizza)) . _.0) . _.1) . _.2)
              ((((((pizza)) . _.0) . _.1) . _.2) . _.3))
            )

(test-check &quot;testc16.tex-31&quot;
            (run5 (x)
                  (unwrapo `((,x)) &apos;pizza))


            `(pizza
              (pizza . _.0)
              ((pizza . _.0) . _.1)
              (((pizza . _.0) . _.1) . _.2)
              ((((pizza . _.0) . _.1) . _.2) . _.3))
            )

(define flatten
  (lambda (s)
    (cond
     ((null? s) &apos;())
     ((pair? s)
      (new-append
       (flatten (car s))
       (flatten (cdr s))))
     (else (cons s &apos;())))))


(test-check &quot;testc16.tex-32&quot;
            (flatten &apos;((a b) c))

            `(a b c))

(define flatteno
  (lambda (s out)
    (conde
      ((nullo s) (== &apos;() out))
      ((pairo s)
       (fresh (a d res-a res-d)
         (conso a d s)
         (flatteno a res-a)
         (flatteno d res-d)
         (appendo res-a res-d out)))
      ((conso s &apos;() out)))))


(test-check &quot;testc16.tex-33&quot;
            (run10 (x)
                   (flatteno &apos;((a b) c) x))


            `((((a b) c))
              ((a b) (c))
              ((a b) c)
              (a (b) (c))
              ((a b) c ())
              (a (b) c)
              (a (b) c ())
              (a b (c))
              (a b () (c))
              (a b c))
            )

(test-check &quot;testc16.tex-34&quot;
            (run10 (x)
                   (flatteno &apos;(a (b c)) x))


            `(((a (b c)))
              (a ((b c)))
              (a (b c))
              (a (b c) ())
              (a b (c))
              (a b (c) ())
              (a b c)
              (a b c ())
              (a b c ())
              (a b c () ()))
            )

(test-check &quot;testc16.tex-35&quot;
            (run* (x)
              (flatteno &apos;(a) x))


            `(((a))
              (a)
              (a ()))
            )

(test-check &quot;testc16.tex-36&quot;
            (run* (x)
              (flatteno &apos;((a)) x))


            `((((a)))
              ((a))
              ((a) ())
              (a)
              (a ())
              (a ())
              (a () ()))
            )

(test-check &quot;testc16.tex-37&quot;
            (run* (x)
              (flatteno &apos;(((a))) x))


            `(((((a))))
              (((a)))
              (((a)) ())
              ((a))
              ((a) ())
              ((a) ())
              ((a) () ())
              (a)
              (a ())
              (a ())
              (a () ())
              (a ())
              (a () ())
              (a () ())
              (a () () ()))
            )

(define flattenogrumblequestion
  (lambda ()


    (run* (x)
      (flatteno &apos;((a b) c) x))


    ))
(define flattenogrumbleanswer


  `((((a b) c))
    ((a b) (c))
    ((a b) c)
    (a (b) (c))
    ((a b) c ())
    (a (b) c)
    (a (b) c ())
    (a b (c))
    (a b () (c))
    (a b c)
    (a b c ())
    (a b () c)
    (a b () c ()))


  )
(test-check &quot;flattenogrumble&quot;
            (flattenogrumblequestion)
            flattenogrumbleanswer)

(define e (make-engine (lambda ()
                         (run* (x)
                           (flatteno x &apos;(a b c)))
                         )))
(printf &quot;Testing testc16.tex-38  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc16.tex-38 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(test-check &quot;testc16.tex-39&quot;
            (length
             (run* (x)
               (flatteno &apos;((((a (((b))) c))) d) x)))

            574)

(define strangeo
  (fresh ()
    strangeo))

(define e (make-engine (lambda ()
                         (run1 (x)
                               strangeo)
                         )))
(printf &quot;Testing testc17.tex-1  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc17.tex-1 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(test-check &quot;testc17.tex-2&quot;
            (run1 (q)
                  (conde
                    (strangeo)
                    (succeed)))

            `(_.0))

(define strangero
  (conde
    (strangero (conde
                 (strangero)
                 (succeed)))
    (succeed)))


(test-check &quot;testc17.tex-3&quot;
            (run5 (q)
                  strangero)

            `(_.0 _.0 _.0 _.0 _.0))

(define strangesto
  (lambda (x y)
    (conde
      ((strangesto y x) (== #f y))
      ((== #f x)))))


(test-check &quot;testc17.tex-4&quot;
            (run5 (q)
                  (fresh (x y)
                    (strangesto x y)
                    (== `(,x ,y) q)))

            `((#f _.0) (_.0 #f) (#f #f) (#f #f) (#f #f)))

(define any*
  (lambda (g)
    (conde
      (g)
      ((any* g)))))


(define never (any* fail))

(define e (make-engine (lambda ()
                         (run1 (q)
                               never
                               (== #t q))
                         )))
(printf &quot;Testing testc17.tex-5  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc17.tex-5 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(run1 (q)
      fail
      never)


(define always (any* succeed))


(test-check &quot;testc17.tex-6&quot;
            (run1 (q)
                  always
                  (== #t q))

            (list #t))
(define e (make-engine (lambda ()
                         (run* (q)
                           always
                           (== #t q))
                         )))
(printf &quot;Testing testc17.tex-7  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc17.tex-7 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(test-check &quot;testc17.tex-8&quot;
            (run5 (q)
                  always
                  (== #t q))

            `(#t #t #t #t #t))

(test-check &quot;testc17.tex-9&quot;
            (run5 (q)
                  (== #t q)
                  always)

            `(#t #t #t #t #t))

(define salo
  (lambda (g)
    (conde
      (succeed)
      (g))))


(test-check &quot;testc17.tex-10&quot;
            (run1 (q)
                  (salo always)
                  (== #t q))

            `(#t))

(test-check &quot;testc17.tex-11&quot;
            (run1 (q)
                  (salo never)
                  (== #t q))

            `(#t))
(define e (make-engine (lambda ()
                         (run* (q)
                           (salo never)
                           (== #t q))
                         )))
(printf &quot;Testing testc17.tex-12  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc17.tex-12 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))

(define e (make-engine (lambda ()
                         (run1 (q)
                               (salo never)
                               fail
                               (== #t q))
                         )))
(printf &quot;Testing testc17.tex-13  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc17.tex-13 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))

(define e (make-engine (lambda ()
                         (run1 (q)
                               always
                               fail
                               (== #t q))
                         )))
(printf &quot;Testing testc17.tex-14  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc17.tex-14 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(test-check &quot;testc17.tex-15&quot;
            (run1 (q)
                  (conde
                    ((== #f q) always)
                    ((== #t q)))
                  (== #t q))

            `(#t))
(define e (make-engine (lambda ()
                         (run2 (q)
                               (conde
                                 ((== #f q) always)
                                 ((== #t q)))
                               (== #t q))
                         )))
(printf &quot;Testing testc17.tex-16  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc17.tex-16 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(test-check &quot;testc17.tex-17&quot;
            (run5 (q)
                  (conde
                    ((== #f q) always)
                    ((any* (== #t q))))
                  (== #t q))


            `(#t #t #t #t #t)
            )

(test-check &quot;testc17.tex-18&quot;
            (run5 (q)
                  (conde
                    (always)
                    (never))
                  (== #t q))

            `(#t #t #t #t #t))

(test-check &quot;testc17.tex-19&quot;
            (run1 (q)
                  (fresh ()
                    (conde
                      ((== #f q))
                      ((== #t q)))
                    always)
                  (== #t q))

            `(#t))

(test-check &quot;testc17.tex-20&quot;
            (run5 (q)
                  (fresh ()
                    (conde
                      ((== #f q))
                      ((== #t q)))
                    always)
                  (== #t q))

            `(#t #t #t #t #t))

(test-check &quot;testc17.tex-21&quot;
            (run5 (q)
                  (fresh ()
                    (conde
                      ((== #t q))
                      ((== #f q)))
                    always)
                  (== #t q))

            `(#t #t #t #t #t))

(define bit-xoro
  (lambda (x y r)
    (conde
      ((== 0 x) (== 0 y) (== 0 r))
      ((== 0 x) (== 1 y) (== 1 r))
      ((== 1 x) (== 0 y) (== 1 r))
      ((== 1 x) (== 1 y) (== 0 r)))))


(test-check &quot;testc20.tex-1&quot;
            (run* (s)
              (fresh (x y)
                (bit-xoro x y 0)
                (== `(,x ,y) s)))


            `((0 0)
              (1 1))
            )

(test-check &quot;testc20.tex-2&quot;
            (run* (s)
              (fresh (x y)
                (bit-xoro x y 1)
                (== `(,x ,y) s)))


            `((0 1)
              (1 0))
            )

(test-check &quot;testc20.tex-3&quot;
            (run* (s)
              (fresh (x y r)
                (bit-xoro x y r)
                (== `(,x ,y ,r) s)))


            `((0 0 0)
              (0 1 1)
              (1 0 1)
              (1 1 0))
            )

(define bit-ando
  (lambda (x y r)
    (conde
      ((== 0 x) (== 0 y) (== 0 r))
      ((== 1 x) (== 0 y) (== 0 r))
      ((== 0 x) (== 1 y) (== 0 r))
      ((== 1 x) (== 1 y) (== 1 r)))))


(test-check &quot;testc20.tex-4&quot;
            (run* (s)
              (fresh (x y)
                (bit-ando x y 1)
                (== `(,x ,y) s)))


            `((1 1))
            )

(define half-addero
  (lambda (x y r c)
    (fresh ()
      (bit-xoro x y r)
      (bit-ando x y c))))


(test-check &quot;testc20.tex-5&quot;
            (run* (r)
              (half-addero 1 1 r 1))

            (list 0))

(test-check &quot;testc20.tex-6&quot;
            (run* (s)
              (fresh (x y r c)
                (half-addero x y r c)
                (== `(,x ,y ,r ,c) s)))


            `((0 0 0 0)
              (0 1 1 0)
              (1 0 1 0)
              (1 1 0 1))
            )

(define full-addero
  (lambda (b x y r c)
    (fresh (w xy wz)
      (half-addero x y w xy)
      (half-addero w b r wz)
      (bit-xoro xy wz c))))


(test-check &quot;testc20.tex-7&quot;
            (run* (s)
              (fresh (r c)
                (full-addero 0 1 1 r c)
                (== `(,r ,c) s)))

            (list `(0 1)))

(define full-addero
  (lambda (b x y r c)
    (conde
      ((== 0 b) (== 0 x) (== 0 y) (== 0 r) (== 0 c))
      ((== 1 b) (== 0 x) (== 0 y) (== 1 r) (== 0 c))
      ((== 0 b) (== 1 x) (== 0 y) (== 1 r) (== 0 c))
      ((== 1 b) (== 1 x) (== 0 y) (== 0 r) (== 1 c))
      ((== 0 b) (== 0 x) (== 1 y) (== 1 r) (== 0 c))
      ((== 1 b) (== 0 x) (== 1 y) (== 0 r) (== 1 c))
      ((== 0 b) (== 1 x) (== 1 y) (== 0 r) (== 1 c))
      ((== 1 b) (== 1 x) (== 1 y) (== 1 r) (== 1 c)))))


(test-check &quot;testc20.tex-8&quot;
            (run* (s)
              (fresh (r c)
                (full-addero 1 1 1 r c)
                (== `(,r ,c) s)))

            (list `(1 1)))

(test-check &quot;testc20.tex-9&quot;
            (run* (s)
              (fresh (b x y r c)
                (full-addero b x y r c)
                (== `(,b ,x ,y ,r ,c) s)))


            `((0 0 0 0 0)
              (1 0 0 1 0)
              (0 1 0 1 0)
              (1 1 0 0 1)
              (0 0 1 1 0)
              (1 0 1 0 1)
              (0 1 1 0 1)
              (1 1 1 1 1))
            )


(define build-num
  (lambda (n)
    (cond
     ((zero? n) &apos;())
     ((and (not (zero? n)) (even? n))
      (cons 0
            (build-num (quotient n 2))))
     ((odd? n)
      (cons 1
            (build-num (quotient (- n 1) 2)))))))


(test-check &quot;testc20.tex-10&quot; `(1 0 1)

            (build-num

             5

             ))


(test-check &quot;testc20.tex-11&quot; `(1 1 1)

            (build-num

             7

             ))

(test-check &quot;nine&quot; (build-num
                    9

                    )

            `(1 0 0 1)

            )

(test-check &quot;six&quot; (build-num
                   6

                   )

            `(0 1 1)

            )

(test-check &quot;nineteen&quot; (build-num
                        19

                        )

            `(1 1 0 0 1)

            )

(test-check &quot;biggie&quot; (build-num
                      17290

                      )

            `(0 1 0 1 0 0 0 1 1 1 0 0 0 0 1)

            )


(test-check &quot;testc20.tex-12&quot; (build-num 0)
            `())

(test-check &quot;testc20.tex-13&quot; (build-num 36)
            `(0 0 1 0 0 1))

(test-check &quot;testc20.tex-14&quot; (build-num 19)
            `(1 1 0 0 1))


(define build-num
  (lambda (n)
    (cond
     ((odd? n)
      (cons 1
            (build-num (quotient (- n 1) 2))))
     ((and (not (zero? n)) (even? n))
      (cons 0
            (build-num (quotient n 2))))
     ((zero? n) &apos;()))))


(define poso
  (lambda (n)
    (fresh (a d)
      (== `(,a . ,d) n))))


(test-check &quot;testc20.tex-15&quot;
            (run* (q)
              (poso &apos;(0 1 1))
              (== #t q))

            (list #t))

(test-check &quot;testc20.tex-16&quot;
            (run* (q)
              (poso &apos;(1))
              (== #t q))

            (list #t))

(test-check &quot;testc20.tex-17&quot;
            (run* (q)
              (poso &apos;())
              (== #t q))

            `())

(test-check &quot;testc20.tex-18&quot;
            (run* (r)
              (poso r))

            (list `(_.0 . _.1)))

(define &gt;1o
  (lambda (n)
    (fresh (a ad dd)
      (== `(,a ,ad . ,dd) n))))


(test-check &quot;testc20.tex-19&quot;
            (run* (q)
              (&gt;1o &apos;(0 1 1))
              (== #t q))

            (list #t))

(test-check &quot;testc20.tex-20&quot;
            (run* (q)
              (&gt;1o &apos;(0 1))
              (== #t q))

            `(#t))

(test-check &quot;testc20.tex-21&quot;
            (run* (q)
              (&gt;1o &apos;(1))
              (== #t q))

            `())

(test-check &quot;testc20.tex-22&quot;
            (run* (q)
              (&gt;1o &apos;())
              (== #t q))

            `())

(test-check &quot;testc20.tex-23&quot;
            (run* (r)
              (&gt;1o r))

            (list
             `(_.0 _.1 . _.2)
             ))


(define addero
  (lambda (d n m r)
    (conde
      ((== 0 d) (== &apos;() m) (== n r))
      ((== 0 d) (== &apos;() n) (== m r)
       (poso m))
      ((== 1 d) (== &apos;() m)
       (addero 0 n &apos;(1) r))
      ((== 1 d) (== &apos;() n) (poso m)
       (addero 0 &apos;(1) m r))
      ((== &apos;(1) n) (== &apos;(1) m)
       (fresh (a c)
         (== `(,a ,c) r)
         (full-addero d 1 1 a c)))
      ((== &apos;(1) n) (gen-addero d n m r))
      ((== &apos;(1) m) (&gt;1o n) (&gt;1o r)
       (addero d &apos;(1) n r))
      ((&gt;1o n) (gen-addero d n m r)))))

(define gen-addero
  (lambda (d n m r)
    (fresh (a b c e x y z)
      (== `(,a . ,x) n)
      (== `(,b . ,y) m) (poso y)
      (== `(,c . ,z) r) (poso z)
      (full-addero d a b c e)
      (addero e x y z))))


(test-check &quot;testc20.tex-24&quot;
            (run3 (s)
                  (fresh (x y r)
                    (addero 0 x y r)
                    (== `(,x ,y ,r) s)))


            `((_.0 () _.0)
              (() (_.0 . _.1) (_.0 . _.1))
              ((1) (1) (0 1)))
            )

(test-check &quot;testc20.tex-25&quot;
            (run22 (s)
                   (fresh (x y r)
                     (addero 0 x y r)
                     (== `(,x ,y ,r) s)))


            `((_.0 () _.0)
              (() (_.0 . _.1) (_.0 . _.1))
              ((1) (1) (0 1))
              ((1) (0 _.0 . _.1) (1 _.0 . _.1))
              ((1) (1 1) (0 0 1))
              ((0 _.0 . _.1) (1) (1 _.0 . _.1))
              ((1) (1 0 _.0 . _.1) (0 1 _.0 . _.1))
              ((0 1) (0 1) (0 0 1))
              ((1) (1 1 1) (0 0 0 1))
              ((1 1) (1) (0 0 1))
              ((1) (1 1 0 _.0 . _.1) (0 0 1 _.0 . _.1))
              ((1 1) (0 1) (1 0 1))
              ((1) (1 1 1 1) (0 0 0 0 1))
              ((1 0 _.0 . _.1) (1) (0 1 _.0 . _.1))
              ((1) (1 1 1 0 _.0 . _.1) (0 0 0 1 _.0 . _.1))
              ((1) (1 1 1 1 1) (0 0 0 0 0 1))
              ((1 1 1) (1) (0 0 0 1))
              ((1) (1 1 1 1 0 _.0 . _.1) (0 0 0 0 1 _.0 . _.1))
              ((1) (1 1 1 1 1 1) (0 0 0 0 0 0 1))
              ((0 1) (1 1) (1 0 1))
              ((1 1 0 _.0 . _.1) (1) (0 0 1 _.0 . _.1))
              ((1) (1 1 1 1 1 0 _.0 . _.1) (0 0 0 0 0 1 _.0 . _.1)))
            )



(test-check &quot;testc20.tex-26&quot;
            (run* (s)
              (gen-addero 1 &apos;(0 1 1) &apos;(1 1) s))

            (list `(0 1 0 1)))

(test-check &quot;testc20.tex-27&quot;
            (run* (s)
              (fresh (x y)
                (addero 0 x y &apos;(1 0 1))
                (== `(,x ,y) s)))


            `(((1 0 1) ())
              (() (1 0 1))
              ((1) (0 0 1))
              ((0 0 1) (1))
              ((1 1) (0 1))
              ((0 1) (1 1)))
            )

(run* (s)
  (fresh (x y)
    (addero 0 x y &apos;(1 0 1))
    (== `(,x ,y) s)))


(define pluso
  (lambda (n m k)
    (addero 0 n m k)))


(run* (s)
  (fresh (x y)
    (pluso x y &apos;(1 0 1))
    (== `(,x ,y) s)))


(test-check &quot;testc20.tex-28&quot;
            (run* (s)
              (fresh (x y)
                (pluso x y &apos;(1 0 1))
                (== `(,x ,y) s)))


            `(((1 0 1) ())
              (() (1 0 1))
              ((1) (0 0 1))
              ((0 0 1) (1))
              ((1 1) (0 1))
              ((0 1) (1 1)))
            )

(define minuso
  (lambda (n m k)
    (pluso m k n)))


(test-check &quot;testc20.tex-29&quot;
            (run* (q)
              (minuso &apos;(0 0 0 1) &apos;(1 0 1) q))


            `((1 1))
            )

(test-check &quot;testc20.tex-30&quot;
            (run* (q)
              (minuso &apos;(0 1 1) &apos;(0 1 1) q))


            `(())
            )

(test-check &quot;testc20.tex-31&quot;
            (run* (q)
              (minuso &apos;(0 1 1) &apos;(0 0 0 1) q))


            `()
            )


(define *o
  (lambda (n m p)
    (conde
      ((== &apos;() n) (== &apos;() p))
      ((poso n) (== &apos;() m) (== &apos;() p))
      ((== &apos;(1) n) (poso m) (== m p))
      ((&gt;1o n) (== &apos;(1) m) (== n p))
      ((fresh (x z)
         (== `(0 . ,x) n) (poso x)
         (== `(0 . ,z) p) (poso z)
         (&gt;1o m)
         (*o x m z)))
      ((fresh (x y)
         (== `(1 . ,x) n) (poso x)
         (== `(0 . ,y) m) (poso y)
         (*o m n p)))
      ((fresh (x y)
         (== `(1 . ,x) n) (poso x)
         (== `(1 . ,y) m) (poso y)
         (odd-*o x n m p))))))

(define odd-*o
  (lambda (x n m p)
    (fresh (q)
      (bound-*o q p n m)
      (*o x m q)
      (pluso `(0 . ,q) m p))))

(define bound-*o
  (lambda (q p n m)
    (conde
      ((nullo q) (pairo p))
      ((fresh (x y z)
         (cdro q x)
         (cdro p y)
         (conde
           ((nullo n)
            (cdro m z)
            (bound-*o x y z &apos;()))
           ((cdro n z)
            (bound-*o x y z m))))))))


(test-check &quot;testc21.tex-1&quot;
            (run34 (t)
                   (fresh (x y r)
                     (*o x y r)
                     (== `(,x ,y ,r) t)))


            `((() _.0 ())
              ((_.0 . _.1) () ())
              ((1) (_.0 . _.1) (_.0 . _.1))
              ((_.0 _.1 . _.2) (1) (_.0 _.1 . _.2))
              ((0 1) (_.0 _.1 . _.2) (0 _.0 _.1 . _.2))
              ((0 0 1) (_.0 _.1 . _.2) (0 0 _.0 _.1 . _.2))
              ((1 _.0 . _.1) (0 1) (0 1 _.0 . _.1))
              ((0 0 0 1) (_.0 _.1 . _.2) (0 0 0 _.0 _.1 . _.2))
              ((1 _.0 . _.1) (0 0 1) (0 0 1 _.0 . _.1))
              ((0 1 _.0 . _.1) (0 1) (0 0 1 _.0 . _.1))
              ((0 0 0 0 1) (_.0 _.1 . _.2) (0 0 0 0 _.0 _.1 . _.2))
              ((1 _.0 . _.1) (0 0 0 1) (0 0 0 1 _.0 . _.1))
              ((0 1 _.0 . _.1) (0 0 1) (0 0 0 1 _.0 . _.1))
              ((0 0 1 _.0 . _.1) (0 1) (0 0 0 1 _.0 . _.1))
              ((1 1) (1 1) (1 0 0 1))
              ((0 0 0 0 0 1) (_.0 _.1 . _.2) (0 0 0 0 0 _.0 _.1 . _.2))
              ((1 _.0 . _.1) (0 0 0 0 1) (0 0 0 0 1 _.0 . _.1))
              ((0 1 _.0 . _.1) (0 0 0 1) (0 0 0 0 1 _.0 . _.1))
              ((0 0 1 _.0 . _.1) (0 0 1) (0 0 0 0 1 _.0 . _.1))
              ((0 0 0 1 _.0 . _.1) (0 1) (0 0 0 0 1 _.0 . _.1))
              ((1 1) (1 0 1) (1 1 1 1))
              ((0 1 1) (1 1) (0 1 0 0 1))
              ((1 1) (1 1 1) (1 0 1 0 1))
              ((1 1) (0 1 1) (0 1 0 0 1))
              ((0 0 0 0 0 0 1) (_.0 _.1 . _.2) (0 0 0 0 0 0 _.0 _.1 . _.2))
              ((1 _.0 . _.1) (0 0 0 0 0 1) (0 0 0 0 0 1 _.0 . _.1))
              ((0 1 _.0 . _.1) (0 0 0 0 1) (0 0 0 0 0 1 _.0 . _.1))
              ((0 0 1 _.0 . _.1) (0 0 0 1) (0 0 0 0 0 1 _.0 . _.1))
              ((0 0 0 1 _.0 . _.1) (0 0 1) (0 0 0 0 0 1 _.0 . _.1))
              ((1 0 1) (1 1) (1 1 1 1))
              ((0 0 0 0 1 _.0 . _.1) (0 1) (0 0 0 0 0 1 _.0 . _.1))
              ((0 1 1) (1 0 1) (0 1 1 1 1))
              ((0 0 1 1) (1 1) (0 0 1 0 0 1))
              ((1 1) (1 0 0 1) (1 1 0 1 1)))
            )

(test-check &quot;testc21.tex-2&quot;
            (run* (p)
              (*o &apos;(0 1) &apos;(0 0 1) p))

            (list `(0 0 0 1)))



(define bound-*o
  (lambda (q p n m)
    succeed))


(test-check &quot;testc21.tex-3&quot;
            (run1 (t)
                  (fresh (n m)
                    (*o n m &apos;(1))
                    (== `(,n ,m) t)))

            (list `((1) (1))))
(define e (make-engine (lambda ()
                         (run2 (t)
                               (fresh (n m)
                                 (*o n m &apos;(1))
                                 (== `(,n ,m) t)))
                         )))
(printf &quot;Testing testc21.tex-4  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc21.tex-4 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))



(define bound-*o
  (lambda (q p n m)
    (conde
      ((nullo q) (pairo p))
      ((fresh (x y z)
         (cdro q x)
         (cdro p y)
         (conde
           ((nullo n)
            (cdro m z)
            (bound-*o x y z &apos;()))
           ((cdro n z)
            (bound-*o x y z m))))))))



(test-check &quot;testc21.tex-5&quot;
            (run2 (t)
                  (fresh (n m)
                    (*o n m &apos;(1))
                    (== `(,n ,m) t)))

            `(((1) (1))))

(test-check &quot;testc21.tex-6&quot;
            (run* (p)
              (*o &apos;(1 1 1) &apos;(1 1 1 1 1 1) p))

            (list `(1 0 0 1 1 1 0 1 1)))

(define =lo
  (lambda (n m)
    (conde
      ((== &apos;() n) (== &apos;() m))
      ((== &apos;(1) n) (== &apos;(1) m))
      ((fresh (a x b y)
         (== `(,a . ,x) n) (poso x)
         (== `(,b . ,y) m) (poso y)
         (=lo x y))))))


(test-check &quot;testc21.tex-7&quot;
            (run* (t)
              (fresh (w x y)
                (=lo `(1 ,w ,x . ,y) &apos;(0 1 1 0 1))
                (== `(,w ,x ,y) t)))

            (list `(_.0 _.1 (_.2 1))))

(test-check &quot;testc21.tex-8&quot;
            (run* (b)
              (=lo &apos;(1) `(,b)))

            (list 1))

(test-check &quot;testc21.tex-9&quot;
            (run* (n)
              (=lo `(1 0 1 . ,n) &apos;(0 1 1 0 1)))

            (list
             `(_.0 1)
             ))

(test-check &quot;testc21.tex-10&quot;
            (run5 (t)
                  (fresh (y z)
                    (=lo `(1 . ,y) `(1 . ,z))
                    (== `(,y ,z) t)))


            `((() ())
              ((1) (1))
              ((_.0 1) (_.1 1))
              ((_.0 _.1 1) (_.2 _.3 1))
              ((_.0 _.1 _.2 1) (_.3 _.4 _.5 1)))
            )

(test-check &quot;testc21.tex-11&quot;
            (run5 (t)
                  (fresh (y z)
                    (=lo `(1 . ,y) `(0 . ,z))
                    (== `(,y ,z) t)))


            `(((1) (1))
              ((_.0 1) (_.1 1))
              ((_.0 _.1 1) (_.2 _.3 1))
              ((_.0 _.1 _.2 1) (_.3 _.4 _.5 1))
              ((_.0 _.1 _.2 _.3 1) (_.4 _.5 _.6 _.7 1)))
            )

(test-check &quot;testc21.tex-12&quot;
            (run5 (t)
                  (fresh (y z)
                    (=lo `(1 . ,y) `(0 1 1 0 1 . ,z))
                    (== `(,y ,z) t)))


            `(((_.0 _.1 _.2 1) ())
              ((_.0 _.1 _.2 _.3 1) (1))
              ((_.0 _.1 _.2 _.3 _.4 1) (_.5 1))
              ((_.0 _.1 _.2 _.3 _.4 _.5 1) (_.6 _.7 1))
              ((_.0 _.1 _.2 _.3 _.4 _.5 _.6 1) (_.7 _.8 _.9 1)))
            )

(define &lt;lo
  (lambda (n m)
    (conde
      ((== &apos;() n) (poso m))
      ((== &apos;(1) n) (&gt;1o m))
      ((fresh (a x b y)
         (== `(,a . ,x) n) (poso x)
         (== `(,b . ,y) m) (poso y)
         (&lt;lo x y))))))


(test-check &quot;testc21.tex-13&quot;
            (run8 (t)
                  (fresh (y z)
                    (&lt;lo `(1 . ,y) `(0 1 1 0 1 . ,z))
                    (== `(,y ,z) t)))


            `((() _.0)
              ((1) _.0)
              ((_.0 1) _.1)
              ((_.0 _.1 1) _.2)
              ((_.0 _.1 _.2 1) (_.3 . _.4))
              ((_.0 _.1 _.2 _.3 1) (_.4 _.5 . _.6))
              ((_.0 _.1 _.2 _.3 _.4 1) (_.5 _.6 _.7 . _.8))
              ((_.0 _.1 _.2 _.3 _.4 _.5 1) (_.6 _.7 _.8 _.9 . _.10)))
            )
(define e (make-engine (lambda ()
                         (run1 (n)
                               (&lt;lo n n))
                         )))
(printf &quot;Testing testc21.tex-14  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc21.tex-14 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(define &lt;=lo
  (lambda (n m)
    (conde
      ((=lo n m))
      ((&lt;lo n m)))))


(test-check &quot;testc21.tex-15&quot;
            (run8 (t)
                  (fresh (n m)
                    (&lt;=lo n m)
                    (== `(,n ,m) t)))


            `((() ())
              ((1) (1))
              (() (_.0 . _.1))
              ((1) (_.0 _.1 . _.2))
              ((_.0 1) (_.1 1))
              ((_.0 1) (_.1 _.2 _.3 . _.4))
              ((_.0 _.1 1) (_.2 _.3 1))
              ((_.0 _.1 _.2 1) (_.3 _.4 _.5 1)))
            )

(test-check &quot;testc21.tex-16&quot;
            (run1 (t)
                  (fresh (n m)
                    (&lt;=lo n m)
                    (*o n &apos;(0 1) m)
                    (== `(,n ,m) t)))

            (list `(() ())))

(test-check &quot;testc21.tex-17&quot;
            (run10 (t)
                   (fresh (n m)
                     (&lt;=lo n m)
                     (*o n &apos;(0 1) m)
                     (== `(,n ,m) t)))


            `((() ())
              ((1) (0 1))
              ((0 1) (0 0 1))
              ((1 1) (0 1 1))
              ((1 _.0 1) (0 1 _.0 1))
              ((0 0 1) (0 0 0 1))
              ((0 1 1) (0 0 1 1))
              ((1 _.0 _.1 1) (0 1 _.0 _.1 1))
              ((0 1 _.0 1) (0 0 1 _.0 1))
              ((0 0 0 1) (0 0 0 0 1)))
            )

(test-check &quot;testc21.tex-18&quot;
            (run15 (t)
                   (fresh (n m)
                     (&lt;=lo n m)
                     (== `(,n ,m) t)))


            `((() ())
              ((1) (1))
              (() (_.0 . _.1))
              ((1) (_.0 _.1 . _.2))
              ((_.0 1) (_.1 1))
              ((_.0 1) (_.1 _.2 _.3 . _.4))
              ((_.0 _.1 1) (_.2 _.3 1))
              ((_.0 _.1 _.2 1) (_.3 _.4 _.5 1))
              ((_.0 _.1 1) (_.2 _.3 _.4 _.5 . _.6))
              ((_.0 _.1 _.2 _.3 1) (_.4 _.5 _.6 _.7 1))
              ((_.0 _.1 _.2 1) (_.3 _.4 _.5 _.6 _.7 . _.8))
              ((_.0 _.1 _.2 _.3 _.4 1) (_.5 _.6 _.7 _.8 _.9 1))
              ((_.0 _.1 _.2 _.3 1) (_.4 _.5 _.6 _.7 _.8 _.9 . _.10))
              ((_.0 _.1 _.2 _.3 _.4 _.5 1) (_.6 _.7 _.8 _.9 _.10 _.11 1))
              ((_.0 _.1 _.2 _.3 _.4 1) (_.5 _.6 _.7 _.8 _.9 _.10 _.11 . _.12)))
            )

(define &lt;o
  (lambda (n m)
    (conde
      ((&lt;lo n m))
      ((=lo n m)
       (fresh (x)
         (poso x)
         (pluso n x m))))))


(define &lt;=o
  (lambda (n m)
    (conde
      ((== n m))
      ((&lt;o n m)))))


(test-check &quot;testc21.tex-19&quot;
            (run* (q)
              (&lt;o &apos;(1 0 1) &apos;(1 1 1))
              (== #t q))

            (list #t))

(test-check &quot;testc21.tex-20&quot;
            (run* (q)
              (&lt;o &apos;(1 1 1) &apos;(1 0 1))
              (== #t q))

            `())

(test-check &quot;testc21.tex-21&quot;
            (run* (q)
              (&lt;o &apos;(1 0 1) &apos;(1 0 1))
              (== #t q))

            `())

(test-check &quot;lessthanequalo-1&quot;
            (run* (q)
              (&lt;=o &apos;(1 0 1) &apos;(1 0 1))
              (== #t q))

            `(#t))

(test-check &quot;testc21.tex-22&quot;
            (run6 (n)
                  (&lt;o n `(1 0 1)))


            `(() (1) (_.0 1) (0 0 1))
            )

(test-check &quot;testc21.tex-23&quot;
            (run6 (m)
                  (&lt;o `(1 0 1) m))


            `((_.0 _.1 _.2 _.3 . _.4) (0 1 1) (1 1 1))
            )
(define e (make-engine (lambda ()
                         (run* (n)
                           (&lt;o n n))
                         )))
(printf &quot;Testing testc21.tex-24  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc21.tex-24 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))



(define /o
  (lambda (n m q r)
    (conde
      ((== r n) (== &apos;() q) (&lt;o n m))
      ((== &apos;(1) q) (=lo n m) (pluso r m n)
       (&lt;o r m))
      ((&lt;lo m n)
       (&lt;o r m)
       (poso q)
       (fresh (nh nl qh ql qlm qlmr rr rh)
         (splito n r nl nh)
         (splito q r ql qh)
         (conde
           ((== &apos;() nh)
            (== &apos;() qh)
            (minuso nl r qlm)
            (*o ql m qlm))
           ((poso nh)
            (*o ql m qlm)
            (pluso qlm r qlmr)
            (minuso qlmr nl rr)
            (splito rr r &apos;() rh)
            (/o nh m qh rh))))))))

(define splito
  (lambda (n r l h)
    (conde
      ((== &apos;() n) (== &apos;() h) (== &apos;() l))
      ((fresh (b n^)
         (== `(0 ,b . ,n^) n)
         (== &apos;() r)
         (== `(,b . ,n^) h)
         (== &apos;() l)))
      ((fresh (n^)
         (==  `(1 . ,n^) n)
         (== &apos;() r)
         (== n^ h)
         (== &apos;(1) l)))
      ((fresh (b n^ a r^)
         (== `(0 ,b . ,n^) n)
         (== `(,a . ,r^) r)
         (== &apos;() l)
         (splito `(,b . ,n^) r^ &apos;() h)))
      ((fresh (n^ a r^)
         (== `(1 . ,n^) n)
         (== `(,a . ,r^) r)
         (== &apos;(1) l)
         (splito n^ r^ &apos;() h)))
      ((fresh (b n^ a r^ l^)
         (== `(,b . ,n^) n)
         (== `(,a . ,r^) r)
         (== `(,b . ,l^) l)
         (poso l^)
         (splito n^ r^ l^ h))))))


(test-check &quot;testc21.tex-25&quot;
            (run6 (t)
                  (fresh (n m q r)
                    (/o n m q r)
                    (== `(,n ,m ,q ,r) t)))


            `((() (_.0 . _.1) () ())
              ((1) (_.0 _.1 . _.2) () (1))
              ((_.0 1) (_.1 _.2 _.3 . _.4) () (_.0 1))
              ((_.0 _.1 1) (_.2 _.3 _.4 _.5 . _.6) () (_.0 _.1 1))
              ((_.0 _.1 _.2 1) (_.3 _.4 _.5 _.6 _.7 . _.8) () (_.0 _.1 _.2 1))
              ((_.0 _.1 _.2 _.3 1) (_.4 _.5 _.6 _.7 _.8 _.9 . _.10) () (_.0 _.1 _.2 _.3 1)))
            )





(define /o
  (lambda (n m q r)
    (conde
      ((== &apos;() q) (== n r) (&lt;o n m))
      ((== &apos;(1) q) (== &apos;() r) (== n m)
       (&lt;o r m))
      ((&lt;o m n) (&lt;o r m)
       (fresh (mq)
         (&lt;=lo mq n)
         (*o m q mq)
         (pluso mq r n))))))



(define /otest1
  (lambda ()


    (run3 (t)
          (fresh (y z)
            (/o `(1 0 . ,y) &apos;(0 1) z &apos;())
            (== `(,y ,z) t)))


    ))
(define e (make-engine /otest1))
(printf &quot;Testing testc23.tex-/otest1  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc23.tex-/otest1 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))



(define /o
  (lambda (n m q r)
    (conde
      ((== r n) (== &apos;() q) (&lt;o n m))
      ((== &apos;(1) q) (=lo n m) (pluso r m n)
       (&lt;o r m))
      ((&lt;lo m n)
       (&lt;o r m)
       (poso q)
       (fresh (nh nl qh ql qlm qlmr rr rh)
         (splito n r nl nh)
         (splito q r ql qh)
         (conde
           ((== &apos;() nh)
            (== &apos;() qh)
            (minuso nl r qlm)
            (*o ql m qlm))
           ((poso nh)
            (*o ql m qlm)
            (pluso qlm r qlmr)
            (minuso qlmr nl rr)
            (splito rr r &apos;() rh)
            (/o nh m qh rh))))))))

(define splito
  (lambda (n r l h)
    (conde
      ((== &apos;() n) (== &apos;() h) (== &apos;() l))
      ((fresh (b n^)
         (== `(0 ,b . ,n^) n)
         (== &apos;() r)
         (== `(,b . ,n^) h)
         (== &apos;() l)))
      ((fresh (n^)
         (==  `(1 . ,n^) n)
         (== &apos;() r)
         (== n^ h)
         (== &apos;(1) l)))
      ((fresh (b n^ a r^)
         (== `(0 ,b . ,n^) n)
         (== `(,a . ,r^) r)
         (== &apos;() l)
         (splito `(,b . ,n^) r^ &apos;() h)))
      ((fresh (n^ a r^)
         (== `(1 . ,n^) n)
         (== `(,a . ,r^) r)
         (== &apos;(1) l)
         (splito n^ r^ &apos;() h)))
      ((fresh (b n^ a r^ l^)
         (== `(,b . ,n^) n)
         (== `(,a . ,r^) r)
         (== `(,b . ,l^) l)
         (poso l^)
         (splito n^ r^ l^ h))))))


(define logo
  (lambda (n b q r)
    (conde
      ((== &apos;(1) n) (poso b) (== &apos;() q) (== &apos;() r))
      ((== &apos;() q) (&lt;o n b) (pluso r &apos;(1) n))
      ((== &apos;(1) q) (&gt;1o b) (=lo n b) (pluso r b n))
      ((== &apos;(1) b) (poso q) (pluso r &apos;(1) n))
      ((== &apos;() b) (poso q) (== r n))
      ((== &apos;(0 1) b)
       (fresh (a ad dd)
         (poso dd)
         (== `(,a ,ad . ,dd) n)
         (exp2 n &apos;() q)
         (fresh (s)
           (splito n dd r s))))
      ((fresh (a ad add ddd)
         (conde
           ((== &apos;(1 1) b))
           ((== `(,a ,ad ,add . ,ddd) b))))
       (&lt;lo b n)
       (fresh (bw1 bw nw nw1 ql1 ql s)
         (exp2 b &apos;() bw1)
         (pluso bw1 &apos;(1) bw)
         (&lt;lo q n)
         (fresh (q1 bwq1)
           (pluso q &apos;(1) q1)
           (*o bw q1 bwq1)
           (&lt;o nw1 bwq1))
         (exp2 n &apos;() nw1)
         (pluso nw1 &apos;(1) nw)
         (/o nw bw ql1 s)
         (pluso ql &apos;(1) ql1)
         (&lt;=lo ql q)
         (fresh (bql qh s qdh qd)
           (repeated-mul b ql bql)
           (/o nw bw1 qh s)
           (pluso ql qdh qh)
           (pluso ql qd q)
           (&lt;=o qd qdh)
           (fresh (bqd bq1 bq)
             (repeated-mul b qd bqd)
             (*o bql bqd bq)
             (*o b bq bq1)
             (pluso bq r n)
             (&lt;o n bq1))))))))


(define exp2
  (lambda (n b q)
    (conde
      ((== &apos;(1) n) (== &apos;() q))
      ((&gt;1o n) (== &apos;(1) q)
       (fresh (s)
         (splito n b s &apos;(1))))
      ((fresh (q1 b2)
         (== `(0 . ,q1) q)
         (poso q1)
         (&lt;lo b n)
         (appendo b `(1 . ,b) b2)
         (exp2 n b2 q1)))
      ((fresh (q1 nh b2 s)
         (== `(1 . ,q1) q)
         (poso q1)
         (poso nh)
         (splito n b s nh)
         (appendo b `(1 . ,b) b2)
         (exp2 nh b2 q1))))))


(define repeated-mul
  (lambda (n q nq)
    (conde
      ((poso n) (== &apos;() q) (== &apos;(1) nq))
      ((== &apos;(1) q) (== n nq))
      ((&gt;1o q)
       (fresh (q1 nq1)
         (pluso q1 &apos;(1) q)
         (repeated-mul n q1 nq1)
         (*o nq1 n nq))))))


(test-check &quot;testc21.tex-26&quot;
            (run* (r)
              (logo &apos;(0 1 1 1) &apos;(0 1) &apos;(1 1) r))

            (list `(0 1 1)))


&apos;(printf &quot;This next test takes several minutes to run!\n&quot;)


&apos;(test-check &quot;testc21.tex-27&quot;
             (run9 (s)
                   (fresh (b q r)
                     (logo &apos;(0 0 1 0 0 0 1) b q r)
                     (&gt;1o q)
                     (== `(,b ,q ,r) s)))


             `((() (_.0 _.1 . _.2) (0 0 1 0 0 0 1))
               ((1) (_.0  _.1 . _.2) (1 1 0 0 0 0 1))
               ((0 1) (0 1 1) (0 0 1))
               ((1 1) (1 1) (1 0 0 1 0 1))
               ((0 0 1) (1 1) (0 0 1))
               ((0 0 0 1) (0 1) (0 0 1))
               ((1 0 1) (0 1) (1 1 0 1 0 1))
               ((0 1 1) (0 1) (0 0 0 0 0 1))
               ((1 1 1) (0 1) (1 1 0 0 1)))
             )

(define expo
  (lambda (b q n)
    (logo n b q &apos;())))


&apos;(test-check &quot;testc21.tex-28&quot;
             (run* (t)
               (expo &apos;(1 1) &apos;(1 0 1) t))

             (list `(1 1 0 0 1 1 1 1)))

(define u (var &apos;u))

(define v (var &apos;v))

(define w (var &apos;w))


(define x (var &apos;x))

(define y (var &apos;y))

(define z (var &apos;z))


(test-check &quot;testc22.tex-1&quot;
            (rhs `(,z . b))

            &apos;b)

(test-check &quot;testc22.tex-2&quot;
            (rhs `(,z . ,w))

            w)

(test-check &quot;testc22.tex-3&quot;
            (rhs `(,z . (,x e ,y)))

            `(,x e ,y))


(test-check &quot;testc22.tex-4&quot;
            (walk z `((,z . a) (,x . ,w) (,y . ,z)))

            &apos;a)

(test-check &quot;testc22.tex-5&quot;
            (walk y `((,z . a) (,x . ,w) (,y . ,z)))

            &apos;a)

(test-check &quot;testc22.tex-6&quot;
            (walk x `((,z . a) (,x . ,w) (,y . ,z)))

            w)

(test-check &quot;testc22.tex-7&quot;
            (walk w `((,z . a) (,x . ,w) (,y . ,z)))

            w)

(test-check &quot;testc22.tex-8&quot;
            (walk u `((,x . b) (,w . (,x e ,x)) (,u . ,w)))

            `(,x e ,x))


(test-check &quot;testc22.tex-9&quot;
            (walk y (ext-s x &apos;e `((,z . ,x) (,y . ,z))))

            &apos;e)

(test-check &quot;testc22.tex-10&quot;
            (walk y `((,x . e)))

            y)

(test-check &quot;testc22.tex-11&quot;
            (walk x `((,y . ,z) (,x . ,y)))

            z)

(test-check &quot;testc22.tex-12&quot;
            (walk x (ext-s y z `((,x . ,y))))

            z)

(test-check &quot;testc22.tex-13&quot;
            (walk x (ext-s z &apos;b `((,y . ,z) (,x . ,y))))

            &apos;b)

(test-check &quot;testc22.tex-14&quot;
            (walk x (ext-s z w `((,y . ,z) (,x . ,y))))

            w)


(test-check &quot;testc22.tex-15&quot;
            (occurs-check z u
                          `((,x . (a ,y)) (,w . (,x e ,x)) (,u . ,w) (,y . (,z))))

            #t)



(test-check &quot;testc22.tex-16&quot;
            (walk* x
                   `((,y . (a ,z c)) (,x . ,y) (,z . a)))

            `(a a c))

(test-check &quot;testc22.tex-17&quot;
            (walk* x
                   `((,y . (,z ,w c)) (,x . ,y) (,z . a)))

            `(a ,w c))

(test-check &quot;testc22.tex-18&quot;
            (walk* y
                   `((,y . (,w ,z c)) (,v . b) (,x . ,v) (,z . ,x)))

            `(,w b c))



(test-check &quot;testc22.tex-19&quot;
            (run* (q)
              (== #f q)
              (project (q)
                       (== (not (not q)) q)))

            &apos;(#f))



(test-check &quot;testc22.tex-20&quot;
            (let ((r (walk* `(,x ,y ,z) empty-s)))
              (walk* r (reify-s r empty-s)))

            `(_.0 _.1 _.2))

(test-check &quot;testc22.tex-21&quot;
            (let ((r `(,u (,v (,w ,x) ,y) ,x)))
              (walk* r (reify-s r empty-s)))

            `(_.0 (_.1 (_.2 _.3) _.4) _.3))

(test-check &quot;testc22.tex-22&quot;
            (let ((s `((,y . (,z ,w c ,w)) (,x . ,y) (,z . a))))
              (let ((r (walk* x s)))
                (walk* r (reify-s r empty-s))))

            `(a _.0 c _.0))

(test-check &quot;testc22.tex-23&quot;
            (let ((s `((,y . (,z ,w c ,w)) (,x . ,y) (,z . ,u))))
              (let ((r (walk* x s)))
                (walk* r (reify-s r empty-s))))

            `(_.0 _.1 c _.1))


(test-check &quot;testc22.tex-24&quot;
            (let ((s `((,y . (,z ,w c ,w)) (,x . ,y) (,z . a))))
              (reify x s))

            `(a _.0 c _.0))
(define e (make-engine (lambda ()
                         (run1 (x)
                               (== `(,x) x))
                         )))
(printf &quot;Testing testc22.tex-25  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc22.tex-25 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))

(test-check &quot;testc22.tex-28&quot;
            (run1 (x)
                  (== `(,x) x))

            `())
(define e (make-engine (lambda ()
                         (run1 (x)
                               (fresh (y z)
                                 (== x z)
                                 (== `(a b ,z) y)
                                 (== x y)))
                         )))
(printf &quot;Testing testc22.tex-29  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc22.tex-29 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(test-check &quot;testc22.tex-30&quot;
            (run1 (x)
                  (fresh (y z)
                    (== x z)
                    (== `(a b ,z) y)
                    (== x y)))
            `())
(define e (make-engine (lambda ()
                         (run1 (x)
                               (== `(,x) x))
                         )))
(printf &quot;Testing testc22.tex-31  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc22.tex-31 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(test-check &quot;testc23.tex-fail1&quot; (run* (q)


                                  (conda
                                   (fail succeed)
                                   (fail))


                                  ) &apos;())


(test-check &quot;testc23.tex-succeed1&quot; (not (null? (run* (q)


                                                 (conda
                                                  (fail succeed)
                                                  (succeed))


                                                 ))) #t)


(test-check &quot;testc23.tex-succeed1&quot; (not (null? (run* (q)


                                                 (conda
                                                  (succeed fail)
                                                  (succeed))


                                                 ))) #f)


(test-check &quot;testc23.tex-succeed2&quot; (not (null? (run* (q)


                                                 (conda
                                                  (succeed succeed)
                                                  (fail))


                                                 ))) #t)


(test-check &quot;testc23.tex-1&quot;
            (run* (x)
              (conda
               ((== &apos;olive x) succeed)
               ((== &apos;oil x) succeed)))

            `(olive))

(test-check &quot;testc23.tex-2&quot;
            (run* (x)
              (conda
               ((== &apos;virgin x) fail)
               ((== &apos;olive x) succeed)
               ((== &apos;oil x) succeed)))

            `())

(test-check &quot;testc23.tex-3&quot;
            (run* (q)
              (fresh (x y)
                (== &apos;split x)
                (== &apos;pea y)
                (conda
                 ((== &apos;split x) (== x y))
                 (succeed)))
              (== #t q))

            `())

(test-check &quot;testc23.tex-4&quot;
            (run* (q)
              (fresh (x y)
                (== &apos;split x)
                (== &apos;pea y)
                (conda
                 ((== x y) (== &apos;split x))
                 (succeed)))
              (== #t q))

            (list #t))

(define notpastao
  (lambda (x)
    (conda
     ((== &apos;pasta x) fail)
     (succeed))))


(test-check &quot;testc23.tex-5&quot;
            (run* (x)
              (conda
               ((notpastao x) fail)
               ((== &apos;spaghetti x))))

            &apos;(spaghetti))

(test-check &quot;testc23.tex-6&quot;
            (run* (x)
              (== &apos;spaghetti x)
              (conda
               ((notpastao x) fail)
               ((== &apos;spaghetti x))))

            &apos;())
(define e (make-engine (lambda ()
                         (run* (q)
                           (conda
                            (always succeed)
                            (fail))
                           (== #t q))
                         )))
(printf &quot;Testing testc23.tex-7  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc23.tex-7 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(test-check &quot;testc23.tex-8&quot;
            (run* (q)
              (condu
               (always succeed)
               (fail))
              (== #t q))

            `(#t))
(define e (make-engine (lambda ()
                         (run* (q)
                           (condu
                            (succeed always)
                            (fail))
                           (== #t q))
                         )))
(printf &quot;Testing testc23.tex-9  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc23.tex-9 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))

(define e (make-engine (lambda ()
                         (run1 (q)
                               (conda
                                (always succeed)
                                (fail))
                               fail
                               (== #t q))
                         )))
(printf &quot;Testing testc23.tex-10  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc23.tex-10 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(test-check &quot;testc23.tex-11&quot;
            (run1 (q)
                  (condu
                   (always succeed)
                   (fail))
                  fail
                  (== #t q))

            `())

(define onceo
  (lambda (g)
    (condu
     (g succeed))))


(test-check &quot;testc23.tex-12&quot;
            (run* (x)
              (onceo (teacupo x)))

            `(tea))

(test-check &quot;testc23.tex-13&quot;
            (run1 (q)
                  (onceo (salo never))
                  fail)

            `())

(test-check &quot;testc23.tex-14&quot;
            (run* (r)
              (conde
                ((teacupo r) succeed)
                ((== #f r) succeed)))

            `(#f tea cup))

(test-check &quot;testc23.tex-15&quot;
            (run* (r)
              (conda
               ((teacupo r) succeed)
               ((== #f r) succeed)))

            `(tea cup))

(test-check &quot;testc23.tex-16&quot;
            (run* (r)
              (== #f r)
              (conda
               ((teacupo r) succeed)
               ((== #f r) succeed)))

            `(#f))

(test-check &quot;testc23.tex-17&quot;
            (run* (r)
              (== #f r)
              (condu
               ((teacupo r) succeed)
               ((== #f r) succeed)))

            `(#f))

(define bumpo
  (lambda (n x)
    (conde
      ((== n x) succeed)
      ((fresh (m)
         (minuso n &apos;(1) m)
         (bumpo m x))))))


(test-check &quot;testc23.tex-18&quot;
            (run* (x)
              (bumpo &apos;(1 1 1) x))


            `((1 1 1)
              (0 1 1)
              (1 0 1)
              (0 0 1)
              (1 1)
              (0 1)
              (1)
              ())
            )

(define gen&amp;testo
  (lambda (op i j k)
    (onceo
     (fresh (x y z)
       (op x y z)
       (== i x)
       (== j y)
       (== k z)))))


(test-check &quot;testc23.tex-19&quot;
            (run* (q)
              (gen&amp;testo pluso &apos;(0 0 1) &apos;(1 1) &apos;(1 1 1))
              (== #t q))

            (list
             #t
             ))
(define e (make-engine (lambda ()
                         (run1 (q)
                               (gen&amp;testo pluso &apos;(0 0 1) &apos;(1 1) &apos;(0 1 1)))
                         )))
(printf &quot;Testing testc23.tex-20  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc23.tex-20 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))

(define e (make-engine (lambda ()
                         (run1 (q)
                               (gen&amp;testo pluso &apos;(0 0 1) &apos;(1 1) &apos;(0 1 1)))
                         )))
(printf &quot;Testing testc23.tex-21  (engine with ~s ticks fuel)\n&quot; max-ticks)
(e max-ticks
   (lambda (t v) (error &apos;testc23.tex-21 &quot;infinite loop returned ~s after ~s ticks&quot; v (- max-ticks t)))
   (lambda (e^) (void)))


(define enumerateo
  (lambda (op r n)
    (fresh (i j k)
      (bumpo n i)
      (bumpo n j)
      (op i j k)
      (gen&amp;testo op i j k)
      (== `(,i ,j ,k) r))))


(test-check &quot;testc23.tex-22&quot;
            (run* (s)
              (enumerateo pluso s &apos;(1 1)))


            `(((1 1) (1 1) (0 1 1))
              ((1 1) (0 1) (1 0 1))
              ((1 1) () (1 1))
              ((0 1) (1 1) (1 0 1))
              ((1 1) (1) (0 0 1))
              ((1) (1 1) (0 0 1))
              ((0 1) (0 1) (0 0 1))
              (() (1 1) (1 1))
              ((0 1) () (0 1))
              ((0 1) (1) (1 1))
              ((1) (0 1) (1 1))
              ((1) (1) (0 1))
              ((1) () (1))
              (() (0 1) (0 1))
              (() (1) (1))
              (() () ()))
            )

(run* (s)
  (enumerateo pluso s &apos;(1 1)))


&apos;(test-check &quot;testc23.tex-23&quot;
             (run1 (s)
                   (enumerateo pluso s &apos;(1 1 1)))


             `(((1 1 1) (1 1 1) (0 1 1 1)))
             )







;;;  Will&apos;s toys:

(define proof-that-fresh-needs-an-inc
  (fresh ()
    proof-that-fresh-needs-an-inc))

(test-check &apos;proof-that-run-needs-an-inc
            (run 1 (q)
              (conde
                (proof-that-fresh-needs-an-inc)
                (succeed)))
            &apos;(_.0))

(define proof-that-fresh-needs-an-inc-with-conda
  (conda
   (proof-that-fresh-needs-an-inc)))

(test-check &apos;proof-that-run-needs-an-inc-with-conde-and-conda
            (run 1 (q)
              (conde
                (proof-that-fresh-needs-an-inc)
                (succeed)))
            &apos;(_.0))

(define proof-that-fresh-needs-an-inc-with-conda
  (fresh ()
    (conda
     (proof-that-fresh-needs-an-inc succeed))))

(test-check &apos;proof-that-run-needs-an-inc-with-conde
            (run 1 (q)
              (conde
                (proof-that-fresh-needs-an-inc succeed)
                (succeed)))
            &apos;(_.0))

(test-check &apos;why-conde-must-also-have-an-inc
            ((make-engine
              (lambda ()
                (run 5 (q)
                  (letrec ((f (fresh ()
                                (conde
                                  (f (conde
                                       (f)
                                       (succeed)))
                                  (succeed)))))
                    f))))
             100000
             (lambda (x y) y)
             list)
            &apos;(_.0 _.0 _.0 _.0 _.0))


;;;  Define &apos;test-check&apos; once again, for the end-user.
(define-syntax test-check
  (syntax-rules ()
    ((_ title tested-expression expected-result)
     (begin
       (cout &quot;Testing &quot; title nl)
       (let* ((expected expected-result)
              (produced tested-expression))
         (or (equal? expected produced)
             (errorf &apos;test-check
                     &quot;Failed: ~a~%Expected: ~a~%Computed: ~a~%&quot;
                     &apos;tested-expression expected produced)))))))
</pre>
</body>
</html>
